---
title: Building a Forum with Clojure, Datomic, Angular, and Ansible
created_at: Sat Jul 20 2013 19:23:00 -0500
kind: article
categories: programming
summary: ""
---

After many long months I've finished re-writing
[Grateful Place](http://gratefulplace.com). The site now uses Clojure
as an API server, with Datomic for the database, Angular for the front
end, and Vagrant and Ansible for provisioning and deployment. Below
I'll dive into the code base, describing the most important parts of
each component and how everything works together. We'll cover:

* Clojure API Server
    * Liberator for Consistent API'ing
    * Authentication with Friend
    * Testing a Clojure Web App is More Fun than Testing Rails
    * Serving files generated by Grunt/Angular
    * The Web App as an Executable
* Datomic
    * Why Oh Why Did I Do This
    * The Poopy Code I Wrote to Make Basic Things "Easier"
    * The Good Code I Ripped Off to do Migrations
    * Mapification with Cartographer, My Very Own Clojure Library!!!
* Angular
    * Peeking and Secondary Controllers
    * Directives to the Rescue
* Infrastructure
    * Creating a Local Sandbox with Vagrant
    * Provisioning with Ansible
    * Building and Deploying with a Janky Bash Script and Ansible
* Workflow
    * Emacs Bookmarks, Snippets, and Keybindings
    * tmux Config

All source is available [on github](https://github.com/flyingmachine/gratefulplace2/tree/v1.0.0).


## About the Site

[Grateful Place](http://gratefulplace.com) is my attempt at creating
the kind of online community that I'd like to belong to. It's still in
its infancy, but I'd like for it to become a site where people
consciously help lift each other up. One way to do this is by
expressing gratitude on a daily basis, which has been shown to
actually increase happiness.

Some of the features include watching treads, liking posts, and
creating a basic profile. I have a lot more planned for the future,
like tags and "summary" views, and I think the combination of Clojure +
Angular will make it fun and easy for me to continue development :)

If you want to have a look without diving head-first into hippified
waters (what, do you have something against happiness?), you can
[use the demo site](http://demo.gratefulplace.com).

Now, on to the code!

## Clojure API Server

I'm very happy with using Clojure as an API server. The libraries
involved are lightweight and transparent, with no magic, and that
makes it so easy to fully understand what's going on. That was my
experience with Liberator:

### Liberator

Liberator provided me with a much better abstraction for handling
logic which I was repeating in all of my controllers. For example, my
`create` functions all basically looked like:

```clojure
(defn create!
  [params auth]
  (protect
   (:id auth)
   (if-valid
    params (:create validations/post) errors
    (let [post-map (create-post params)]
      {:body post-map})
    (invalid errors))))
```

The
[actual code](https://github.com/flyingmachine/gratefulplace2/blob/fefbebf463b00328e0bd5660ca5ea33899d7cd39/server/src/gratefulplace/controllers/posts.clj#L33)
is much lengthier and harder to understand.

The problem with the above snippet is that there's too much

```clojure
(defresource create! [params auth]
  :allowed-methods [:post]
  :available-media-types ["application/json"]
  :authorized? (logged-in? auth)

  :malformed? (validator params (:create validations/post))
  :handle-malformed errors-in-ctx

  :post! (create-content ts/create-post params auth record)
  :handle-created record-in-ctx)
```

I started using
[Liberator](http://clojure-liberator.github.io/liberator/) because I
noticed that all of my controllers had the same shape:
