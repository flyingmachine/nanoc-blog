<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    </meta>
    <title>Dissecting The Dumbest Clojure/Noir App In Existence</title>
    <link href='/stylesheets/main.css?4' media='screen' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Ruthie|Gentium+Book+Basic:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/pygments.css?3' media='screen' rel='stylesheet' type='text/css'>
    <link href='http://feeds.feedburner.com/FlyingMachineStudios' rel='alternate' type='application/rss+xml'>
  </head>
  <body>
    <header class='top'>
      <div class='display'>
        <div class='title'>
          <a href='/'>Flying Machine Studios</a>
        </div>
        <div class='subtitle'>
          adventures in making stuff with Daniel Higginbotham
        </div>
      </div>
    </header>
    <div id='document'>
      <div id='contact'>
        <ul>
          <li>
            <a href='http://twitter.com/nonrecursive'>
              <i class='fa fa-twitter'></i>
            </a>
          </li>
          <li>
            <a href='http://www.linkedin.com/in/danielhigginbotham'>
              <i class='fa fa-linkedin'></i>
            </a>
          </li>
          <li>
            <a href='https://github.com/flyingmachine'>
              <i class='fa fa-github'></i>
            </a>
          </li>
          <li>
            <a href='http://feeds.feedburner.com/FlyingMachineStudios'>
              <i class='fa fa-rss'></i>
            </a>
          </li>
        </ul>
      </div>
      <div id='main'>
        <div class='page' id='content'>
          <h1>Dissecting The Dumbest Clojure/Noir App In Existence</h1>
          <div class='date'>25 August 2012</div>
          <p>Recently, I released <a href="http://omgsmackdown.com">OMG! SMACKDOWN!!!</a>,
          which must be the dumbest Clojure/Noir app created to date. This post
          dissects it in excruciating detail.</p>
          
          <p>Here's a preview of what you're in for:</p>
          
          <ul>
          <li>App overview</li>
          <li>Data mappers</li>
          <li>Image resizing and S3 storage</li>
          <li>The (awesome!!!) battle page</li>
          <li>Account creation</li>
          <li>Authentication with friend</li>
          <li>Admining &amp; Moderating</li>
          <li>Handling stylesheets</li>
          <li>Final thoughts</li>
          </ul>
          
          <p>You can find all source code on
          [github](https://github.com/flyingmachine/arenaverse. This article,
          however, has a snapshot of the source, also on
          <a href="https://github.com/flyingmachine/nanoc-blog/tree/master/content/assets/source/clojure/omgsmackdown-dissected">github</a>,
          so that it will continue to make sense long after the app has evolved.</p>
          
          <h2>App Overview</h2>
          
          <p>I created <a href="http://omgsmackdown.com">OMG! SMACKDOWN!!!</a>, a.k.a. the
          dumbest Clojure/Noir app on the planet, over a period of three
          months. Whereas other voting sites like "Hot or Not" and "Kitten War"
          are focused on trivia, I aspired to build a site for voting on
          humanity's more pressing questions. Questions like,
          <a href="http://omgsmackdown.com/arenas/deity-bowling">"Which deity is more badass?"</a>
          and
          <a href="http://omgsmackdown.com/arenas/conquerors-57fd">"Who loved his mama more?"</a>
          and
          <a href="http://omgsmackdown.com/arenas/republicans-vs-monsters">"Which creature is scarier?"</a>. The
          kind of stuff that has made for many a sleepless night among
          philosophers and stoners.</p>
          
          <p>OMG! SMACKDOWN!!! lets you create an "arena" which you populate with "fighters". The fighters are shown, two at a time, along with the arena's question. Clicking on a fighter votes for that fighter. Part of the site's (undeniable) charm is that the fighter pairings are completely random, leading to delightful surprise after delightful surprise.</p>
          
          <h2>Data Mappers</h2>
          
          <p>The app's data mappers are at the heart of everything. I've already
          written a
          <a href="/programming/refactoring-to-datamappers-in-clojure/">fairly thorough description</a>. Here
          I'll focus on a briefer functional explanation so that you'll know
          what's going on when you see data mapper code elsewhere.</p>
          
          <p>OMGS!!! uses mongodb with access provided by <a href="http://clojuremongodb.info/">Clojure Monger</a>, an excellent mongodb library.</p>
          
          <h3>Convenience Functions</h3>
          
          <p>One reason for writing the datamappers was to be able to write code like this:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">filtered-arenas</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">arena/all</span> <span class="p">{</span><span class="ss">:hidden</span> <span class="p">{</span><span class="nv">$exists</span> <span class="nv">false</span><span class="p">}}))</span></pre></div>
          <p>As you can see, the database details are completely hidden. View code
          shouldn't have to worry about storage details. Also, I find this code
          pretty readable - it should be pretty obvious what's going on
          here. The alternative would be something like:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nf">defn</span> <span class="nv">filtered-arenas</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">mc/find-maps</span> <span class="s">"arena"</span> <span class="p">{</span><span class="ss">:hidden</span> <span class="p">{</span><span class="nv">$exists</span> <span class="nv">false</span><span class="p">}}))</span></pre></div>
          <p>Not a huge difference, but the former is definitely better.</p>
          
          <p>In order to achieve this convenience, though, I had to do some dark
          voodoo. This kind of stuff will probably taint your soul:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.data-mappers.db</span><span class="p">)</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">add-db-reqs</span> <span class="p">[]</span>&#x000A;  <span class="o">'</span><span class="p">(</span><span class="nf">do</span>&#x000A;     <span class="p">(</span><span class="nf">require</span> <span class="ss">'monger.collection</span><span class="p">)</span>&#x000A;     <span class="p">(</span><span class="nb">import </span><span class="o">'</span><span class="p">(</span><span class="nf">org.bson.types</span> <span class="nv">ObjectId</span><span class="p">))</span>&#x000A;     <span class="p">(</span><span class="nf">use</span> <span class="ss">'monger.operators</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; TODO ~' Insanity! #cthulhu</span>&#x000A;<span class="c1">;; These macros are meant to infect the namespace with functions. Why</span>&#x000A;<span class="c1">;; would I want to do this? Should I take heed of the fact that</span>&#x000A;<span class="c1">;; Clojure really doesn't want me to?</span>&#x000A;&#x000A;<span class="c1">;; I wrote these fucntions to avoid having to write collection-name</span>&#x000A;<span class="c1">;; all over the place</span>&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">add-db-fns</span> <span class="p">[</span><span class="nv">collection-name</span><span class="p">]</span>&#x000A;  <span class="o">`</span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">collection-name#</span> <span class="o">~</span><span class="nv">collection-name</span><span class="p">]</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-destroy</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/remove-by-id</span> <span class="nv">collection-name#</span><span class="p">))</span>     &#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-one</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/find-one-as-map</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-one-by-id</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/find-map-by-id</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-all</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/find-maps</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-insert</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/insert</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-update-by-id</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/update-by-id</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-update</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/update</span> <span class="nv">collection-name#</span><span class="p">))))</span>&#x000A;&#x000A;&#x000A;<span class="c1">;; These methods are meant to generate the representations which</span>&#x000A;<span class="c1">;; non-db parts of the code will use. They all convert ObjectId's to</span>&#x000A;<span class="c1">;; strings because no other part of the system should care about ObjectId's</span>&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">add-finder-fns</span> <span class="p">[]</span>&#x000A;  <span class="o">'</span><span class="p">(</span><span class="nf">do</span>&#x000A;     <span class="c1">;; TODO this doesn't feel like it belongs here. It's a helper</span>&#x000A;     <span class="c1">;; method. But this macro approach is infecting everything!</span>&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nf">.toString</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">object-id-&gt;idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nb">assoc </span><span class="nv">record</span> <span class="ss">:_id</span> <span class="p">(</span><span class="nf">idstr</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="c1">;; TODO I don't like mapping in the all fn, feels wasteful.</span>&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">all</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;       <span class="p">(</span><span class="nb">map </span><span class="nv">object-id-&gt;idstr</span> <span class="p">(</span><span class="nf">db-all</span> <span class="nv">query-doc</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">one</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;       <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">r</span> <span class="p">(</span><span class="nf">db-one</span> <span class="nv">query-doc</span><span class="p">)]</span>&#x000A;         <span class="p">(</span><span class="nf">object-id-&gt;idstr</span> <span class="nv">r</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">one-by-id</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">r</span> <span class="p">(</span><span class="nf">db-one-by-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">))]</span>&#x000A;         <span class="p">(</span><span class="nf">object-id-&gt;idstr</span> <span class="nv">r</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">unset</span> <span class="p">[</span><span class="nv">_id</span> <span class="nv">field</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nf">db-update-by-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)</span> <span class="p">{</span><span class="nv">$unset</span> <span class="p">{</span><span class="nv">field</span> <span class="mi">1</span><span class="p">}}))))</span></pre></div>
          <p>As you can see, those macros "infect" a namespace when they're
          called. For example, I call them here in the
          <code>arenaverse.data-mappers.arena</code> namespace:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nf">db/add-db-reqs</span><span class="p">)</span>&#x000A;<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">collection-name</span> <span class="s">"arenas"</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-db-fns</span> <span class="nv">collection-name</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-finder-fns</span><span class="p">))</span></pre></div>
          <p>These macro calls a) ensure dependencies are met and b) expand to a
          series of function definitions. It feels really wrong to use macros to
          create nearly-identical functions in one namespace after another, but
          I'm not sure what a better alternative would be.</p>
          
          <h3>Conventions</h3>
          
          <p>Another function served by these macros is that they ensure that
          conventions are followed. For example, I wanted all queries to convert
          a MongDB <code>ObjectId</code> object to a simple string. This was another way of
          hiding an implementation detail - views shouldn't know WTF an
          <code>ObjectId</code> is. You can see that the dark voodoo macros help in this
          regard:</p>
          <div class="highlight"><pre>     <span class="p">(</span><span class="kd">defn </span><span class="nv">object-id-&gt;idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nb">assoc </span><span class="nv">record</span> <span class="ss">:_id</span> <span class="p">(</span><span class="nf">idstr</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="c1">;; TODO I don't like mapping in the all fn, feels wasteful.</span>&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">all</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;       <span class="p">(</span><span class="nb">map </span><span class="nv">object-id-&gt;idstr</span> <span class="p">(</span><span class="nf">db-all</span> <span class="nv">query-doc</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">one</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;       <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">r</span> <span class="p">(</span><span class="nf">db-one</span> <span class="nv">query-doc</span><span class="p">)]</span>&#x000A;         <span class="p">(</span><span class="nf">object-id-&gt;idstr</span> <span class="nv">r</span><span class="p">)))</span></pre></div>
          <p>One flaw with this approach is that it doesn't quite cover every
          situation. For example, when I create a user I have to manually
          convert the <code>ObjectId</code> to string:</p>
          
          <p>source. clojure/omgsmackdown-dissected/data_mappers/user.clj 21-24</p>
          
          <p>This is necessary in order to remain consistent with the convention
          that data mapper functions convert the <code>_id</code> field to a string. In
          most cases, this doesn't matter because I don't actually do anything
          with the return value but in this case it mattered because of the way
          that user signup works. Here's what would happen if I didn't manually
          convert the <code>_id</code>:</p>
          
          <ul>
          <li>User signs up</li>
          <li>Session is populated with user details, including an <code>ObjectId</code> for the <code>_id</code> field</li>
          <li>User creates arena. <code>user-id</code> field of arena is of type <code>ObjectId</code>
          </li>
          <li>User logs out</li>
          <li>User signs in again. Session is populated with user details, including a <code>String</code> for the <code>_id</code> field (because the query methods from db.clj do this conversion)</li>
          <li>List of user's arenas doesn't include the arena created earlier because the query is looking for the <code>String</code> version of the user's <code>_id</code> instead of the <code>ObjectId</code> version</li>
          </ul>
          
          <p>Coming from a Rails background, I'm used to libraries like mongoid
          which handle this conversion/consistency issue for you. My solution is
          a little half-baked and it requires me to pay attention to details
          which I'm not used to paying attention to.</p>
          
          <h2>Image resizing and S3 storage</h2>
          
          <p>OMGS!!! wouldn't be half as fun if images weren't involved. I was too
          lazy to try and find a library that would handle resizing an image,
          associating it with a record, and storing it wherever I wanted (there
          are probably five thousand such gems for Rails). Such a library would
          probably completely unworkable anyway since my datamapper coder is
          completely custom. It's all throughout the code below:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.data-mappers.fighter</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.data-mappers.db</span> <span class="ss">:as</span> <span class="nv">db</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.lib.aws.s3</span> <span class="ss">:as</span> <span class="nv">s3</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.config</span> <span class="ss">:as</span> <span class="nv">config</span><span class="p">])</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.bson.types</span> <span class="nv">ObjectId</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">org.imgscalr</span> <span class="nv">Scalr</span> <span class="nv">Scalr$Method</span> <span class="nv">Scalr$Mode</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">javax.imageio</span> <span class="nv">ImageIO</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">java.awt.image</span> <span class="nv">BufferedImageOp</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">java.awt.image</span> <span class="nv">BufferedImage</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">org.apache.commons.io</span> <span class="nv">FilenameUtils</span><span class="p">]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">declare </span><span class="nv">one-by-id</span><span class="p">)</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">db/add-db-reqs</span><span class="p">)</span>&#x000A;<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">collection-name</span> <span class="s">"fighters"</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-db-fns</span> <span class="nv">collection-name</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-finder-fns</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">*image-versions</span> <span class="p">[[</span><span class="s">"card"</span> <span class="mi">192</span><span class="p">]</span>&#x000A;                      <span class="p">[</span><span class="s">"listing"</span> <span class="mi">64</span><span class="p">]</span>&#x000A;                      <span class="p">[</span><span class="s">"battle"</span> <span class="mi">352</span> <span class="mi">638</span><span class="p">]])</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-relative-path</span> <span class="p">[</span><span class="nv">version</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">_id</span> <span class="nv">image-extension</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"fighters/"</span> <span class="nv">_id</span> <span class="s">"/"</span> <span class="nv">version</span> <span class="s">"."</span> <span class="nv">image-extension</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-path</span> <span class="p">[</span><span class="nv">version</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"/"</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">version</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; TODO not hardcode this</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">bucket-name</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"arenaverse-"</span> <span class="p">(</span><span class="nb">name </span><span class="nv">config/env</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; This is used when displaying an image</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">amazon-image-path</span> <span class="p">[</span><span class="nv">version</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"https://s3.amazonaws.com/"</span> <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span> <span class="p">(</span><span class="nf">image-path</span> <span class="nv">version</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">normalize-image-extension</span> <span class="p">[</span><span class="nv">extension</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">clojure.string/replace</span> <span class="nv">extension</span> <span class="s">"jpeg"</span> <span class="s">"jpg"</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">image-fields</span> <span class="p">[</span><span class="nv">image-extension</span><span class="p">]</span>&#x000A;  <span class="p">{</span><span class="ss">:image-extension</span> <span class="p">(</span><span class="nb">and </span><span class="nv">image-extension</span> <span class="p">(</span><span class="nf">normalize-image-extension</span> <span class="nv">image-extension</span><span class="p">))})</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">resize</span>&#x000A;  <span class="p">([</span><span class="nv">image</span> <span class="nv">box</span><span class="p">]</span>&#x000A;     <span class="p">(</span><span class="nf">resize</span> <span class="nv">image</span> <span class="nv">box</span> <span class="nv">box</span><span class="p">))</span>&#x000A;  <span class="p">([</span><span class="nv">image</span> <span class="nv">target-width</span> <span class="nv">target-height</span><span class="p">]</span>&#x000A;     <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">width</span>  <span class="p">(</span><span class="nf">.getWidth</span> <span class="nv">image</span><span class="p">)</span>&#x000A;           <span class="nv">height</span> <span class="p">(</span><span class="nf">.getHeight</span> <span class="nv">image</span><span class="p">)</span>&#x000A;           <span class="nv">fit</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">/ </span><span class="nv">target-width</span> <span class="nv">width</span><span class="p">)</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">target-height</span> <span class="nv">height</span><span class="p">))</span> <span class="nv">Scalr$Mode/FIT_TO_HEIGHT</span> <span class="nv">Scalr$Mode/FIT_TO_WIDTH</span><span class="p">)]</span>&#x000A;       <span class="p">(</span><span class="nf">Scalr/resize</span> <span class="nv">image</span> <span class="nv">Scalr$Method/ULTRA_QUALITY</span> <span class="nv">fit</span> <span class="nv">target-width</span> <span class="nv">target-height</span> <span class="p">(</span><span class="nb">into-array </span><span class="nv">BufferedImageOp</span> <span class="p">[])))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">buffered-image-&gt;input-stream</span> <span class="p">[</span><span class="nv">buffered-image</span> <span class="nv">extension</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">os</span> <span class="p">(</span><span class="nf">java.io.ByteArrayOutputStream.</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">ImageIO/write</span> <span class="nv">buffered-image</span> <span class="nv">extension</span> <span class="nv">os</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">java.io.ByteArrayInputStream.</span> <span class="p">(</span><span class="nf">.toByteArray</span> <span class="nv">os</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">input-&gt;image-extension</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">FilenameUtils/getExtension</span> <span class="p">(</span><span class="ss">:filename</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">image-uploaded?</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="p">(</span><span class="ss">:size</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="c1">;; TODO paul graham says this is crappy code - but is it easier to understand?</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">input-&gt;images</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-upload</span>   <span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">)</span>&#x000A;          <span class="nv">original-file</span> <span class="p">(</span><span class="ss">:tempfile</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;          <span class="nv">content-type</span>  <span class="p">(</span><span class="ss">:content-type</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;          <span class="nv">original-image</span> <span class="p">{</span><span class="ss">:version</span> <span class="s">"original"</span>&#x000A;                          <span class="ss">:file</span> <span class="nv">original-file</span>&#x000A;                          <span class="ss">:content-type</span> <span class="nv">content-type</span><span class="p">}</span>&#x000A;          <span class="nv">image-extension</span> <span class="p">(</span><span class="nf">normalize-image-extension</span> <span class="p">(</span><span class="nf">input-&gt;image-extension</span> <span class="nv">input</span><span class="p">))</span>&#x000A;          <span class="nv">buff-img</span> <span class="p">(</span><span class="nf">ImageIO/read</span> <span class="nv">original-file</span><span class="p">)]</span>&#x000A;&#x000A;      <span class="c1">;; TODO make this a lazy seq</span>&#x000A;      <span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">version</span> <span class="o">&amp;</span> <span class="nv">dim</span><span class="p">]]</span>&#x000A;                   <span class="p">{</span><span class="ss">:version</span> <span class="nv">version</span>&#x000A;                    <span class="ss">:file</span> <span class="p">(</span><span class="nf">buffered-image-&gt;input-stream</span>&#x000A;                           <span class="p">(</span><span class="nb">apply </span><span class="nv">resize</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">buff-img</span> <span class="nv">dim</span><span class="p">))</span>&#x000A;                           <span class="nv">image-extension</span><span class="p">)</span>&#x000A;                    <span class="ss">:content-type</span> <span class="nv">content-type</span><span class="p">})</span>&#x000A;                 <span class="nv">*image-versions</span><span class="p">)</span>&#x000A;            <span class="nv">original-image</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">store-image</span> <span class="p">[</span><span class="nv">image</span>, <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">s3/put-object</span> <span class="nv">config/*aws-credentials*</span>&#x000A;                 <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span>&#x000A;                 <span class="p">(</span><span class="nf">image-relative-path</span> <span class="p">(</span><span class="ss">:version</span> <span class="nv">image</span><span class="p">)</span> <span class="nv">record</span><span class="p">)</span>&#x000A;                 <span class="p">(</span><span class="ss">:file</span> <span class="nv">image</span><span class="p">)</span>&#x000A;                 <span class="p">{</span><span class="ss">:content-type</span> <span class="p">(</span><span class="ss">:content-type</span> <span class="nv">image</span><span class="p">)}</span>&#x000A;                 <span class="o">#</span><span class="p">(</span><span class="nf">.withCannedAcl</span> <span class="nv">%</span> <span class="nv">com.amazonaws.services.s3.model.CannedAccessControlList/PublicRead</span><span class="p">)))</span>&#x000A;&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">store-images</span> <span class="p">[</span><span class="nv">input</span> <span class="nv">db-fields</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">future</span>&#x000A;    <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">image</span> <span class="p">(</span><span class="nf">input-&gt;images</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;      <span class="p">(</span><span class="nf">store-image</span> <span class="nv">image</span> <span class="nv">db-fields</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">input-&gt;team</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">new-team</span> <span class="p">(</span><span class="ss">:new-team</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">nil? </span><span class="nv">new-team</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="s">""</span> <span class="nv">new-team</span><span class="p">))</span>&#x000A;      <span class="p">(</span><span class="ss">:team</span> <span class="nv">input</span><span class="p">)</span>&#x000A;      <span class="nv">new-team</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; TODO refactor the common dissoc merge pattern</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">create-input-&gt;db-fields</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span><span class="p">)</span>&#x000A;        <span class="nv">team</span> <span class="p">(</span><span class="nf">input-&gt;team</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">merge</span>&#x000A;     <span class="p">(</span><span class="nb">dissoc </span><span class="nv">input</span> <span class="ss">:file</span> <span class="ss">:team</span> <span class="ss">:new-team</span><span class="p">)</span>&#x000A;     <span class="p">{</span><span class="ss">:_id</span> <span class="nv">object-id</span>&#x000A;      <span class="ss">:team</span> <span class="nv">team</span><span class="p">}</span>&#x000A;     <span class="p">(</span><span class="nf">image-fields</span> <span class="p">(</span><span class="nf">input-&gt;image-extension</span> <span class="nv">input</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">update-input-&gt;db-fields</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">team</span> <span class="p">(</span><span class="nf">input-&gt;team</span> <span class="nv">input</span><span class="p">)</span>&#x000A;        <span class="nv">db-fields</span> <span class="p">(</span><span class="nb">merge </span><span class="p">(</span><span class="nb">dissoc </span><span class="nv">input</span> <span class="ss">:file</span> <span class="ss">:team</span> <span class="ss">:new-team</span><span class="p">)</span> <span class="p">{</span><span class="ss">:team</span> <span class="nv">team</span><span class="p">})]</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="nb">merge </span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">image-fields</span> <span class="p">(</span><span class="nf">input-&gt;image-extension</span> <span class="nv">input</span><span class="p">)))</span>&#x000A;      <span class="nv">db-fields</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">create</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">create-input-&gt;db-fields</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">db-insert</span> <span class="nv">db-fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span> <span class="p">(</span><span class="nf">store-images</span> <span class="nv">input</span> <span class="nv">db-fields</span><span class="p">))</span>&#x000A;    <span class="nv">db-fields</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; this is weird... i remove the object id in the -&gt;db-fields method,</span>&#x000A;<span class="c1">;; then add it back again</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">update</span> <span class="p">[</span><span class="nv">_id</span> <span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">update-input-&gt;db-fields</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nb">println </span><span class="nv">db-fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">db-update-by-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)</span> <span class="p">{</span><span class="ss">:$set</span> <span class="nv">db-fields</span><span class="p">})</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">record</span> <span class="p">(</span><span class="nf">one-by-id</span> <span class="nv">_id</span><span class="p">)]</span>&#x000A;      <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span> <span class="p">(</span><span class="nf">store-images</span> <span class="nv">input</span> <span class="nv">record</span><span class="p">))</span>&#x000A;      <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; TODO query S3 first to avoid missing any images if i.e. image</span>&#x000A;<span class="c1">;; version names change</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">delete-images</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">vname</span><span class="p">]</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">*image-versions</span> <span class="p">[</span><span class="s">"original"</span><span class="p">])]</span>&#x000A;    <span class="p">(</span><span class="nf">s3/delete-object</span> <span class="nv">config/*aws-credentials*</span> <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">vname</span> <span class="nv">record</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">destroy</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)</span>&#x000A;        <span class="nv">record</span> <span class="p">(</span><span class="nf">db-one-by-id</span> <span class="nv">object-id</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">delete-images</span> <span class="nv">record</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">db-destroy</span> <span class="nv">object-id</span><span class="p">)))</span></pre></div>
          <p>As you can see, image-processing code takes up a good 2/3 of all the
          code, which is probably a sign that those functions belongs in their
          own namespace. I'll probably do that someday, but for now the code is
          only being used by the <code>fighter</code> model so I feel OK leaving it where
          it is.</p>
          
          <p>The code is a bit hard to decipher, but in general I tried to continue
          following the approach of clearly separating a) data b) transformation
          functions and c) storage functions. The form input is converted to a
          sequence of java Buffered Images, which are then resized, which are
          then transformed to input streams, which are then stored in S3. When
          updating a fighter I had to take particular care to preserve the
          <code>image-extension</code> field when the fighter's form was submitted without
          an image.</p>
          
          <p>There's also something weird happening in the update function:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">update</span> <span class="p">[</span><span class="nv">_id</span> <span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">update-input-&gt;db-fields</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nb">println </span><span class="nv">db-fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">db-update-by-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)</span> <span class="p">{</span><span class="ss">:$set</span> <span class="nv">db-fields</span><span class="p">})</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">record</span> <span class="p">(</span><span class="nf">one-by-id</span> <span class="nv">_id</span><span class="p">)]</span>&#x000A;      <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span> <span class="p">(</span><span class="nf">store-images</span> <span class="nv">input</span> <span class="nv">record</span><span class="p">))</span>&#x000A;      <span class="nv">record</span><span class="p">)))</span></pre></div>
          <p>I update the record, then immediately retrieve it from mongodb in
          order to possibly update the image and to return the fighter
          record. It feels strange to have to perform a <code>select</code> during an
          update.</p>
          
          <h2>The (awesome!!!) battle page</h2>
          
          <p>The battle page is where all the magic happens! It's where you're
          presented with all of life's deepest questions, ready to be voted on
          with a simple mouse click. Here's the full code, which will be
          analyzed in more detail below:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.views.battles</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.views.common</span> <span class="ss">:as</span> <span class="nv">common</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.views.admin.fighters</span> <span class="ss">:as</span> <span class="nv">fighters</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.data-mappers.fighter</span> <span class="ss">:as</span> <span class="nv">fighter</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.data-mappers.arena</span> <span class="ss">:as</span> <span class="nv">arena</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.data-mappers.battle</span> <span class="ss">:as</span> <span class="nv">battle</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">noir.session</span> <span class="ss">:as</span> <span class="nv">session</span><span class="p">])</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:use</span> <span class="nv">noir.core</span>&#x000A;        <span class="nv">hiccup.core</span>&#x000A;        <span class="nv">hiccup.form-helpers</span>&#x000A;        <span class="nv">arenaverse.views.routes</span>&#x000A;        <span class="nv">monger.operators</span><span class="p">)</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.bson.types</span> <span class="nv">ObjectId</span><span class="p">]))</span>&#x000A;&#x000A;&#x000A;<span class="c1">;;------</span>&#x000A;<span class="c1">;; Functions for setting up data for displaying a battle page</span>&#x000A;<span class="c1">;;------</span>&#x000A;<span class="c1">;; TODO how to test this?</span>&#x000A;&#x000A;<span class="c1">;; When there are no teams, it's everybody against everybody</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">random-teamless-fighters</span> <span class="p">[</span><span class="nv">fighters</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">randomer</span> <span class="o">#</span><span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">count </span><span class="nv">fighters</span><span class="p">))</span>&#x000A;        <span class="nb">left </span><span class="p">(</span><span class="nf">randomer</span><span class="p">)</span>&#x000A;        <span class="nb">right </span><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="nv">%</span> <span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">randomer</span><span class="p">)))]</span>&#x000A;    <span class="p">[(</span><span class="nb">nth </span><span class="nv">fighters</span> <span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nb">nth </span><span class="nv">fighters</span> <span class="nv">right</span><span class="p">)]))</span>&#x000A;&#x000A;<span class="c1">;; When we're dealing with an arena that has teams, we need to ensure</span>&#x000A;<span class="c1">;; that we don't pit two fighters from the same team against each other</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">random-team-fighters</span> <span class="p">[</span><span class="nv">fighters</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">randomer</span> <span class="o">#</span><span class="p">(</span><span class="nb">nth </span><span class="nv">fighters</span> <span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">count </span><span class="nv">fighters</span><span class="p">)))</span>&#x000A;        <span class="nb">left </span><span class="p">(</span><span class="nf">randomer</span><span class="p">)</span>&#x000A;        <span class="nb">right </span><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="ss">:team</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="ss">:team</span> <span class="nv">left</span><span class="p">))</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">randomer</span><span class="p">)))]</span>&#x000A;    <span class="p">[</span><span class="nb">left </span><span class="nv">right</span><span class="p">]))</span>&#x000A;&#x000A;<span class="c1">;; Return a random list of fighters for a given arena id</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">random-fighters</span> <span class="p">[</span><span class="nv">arena-id</span><span class="p">]</span>&#x000A;  <span class="c1">;; The image-extension filter ensures that we don't get fighters</span>&#x000A;  <span class="c1">;; that are missing an image</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">fighters</span> <span class="p">(</span><span class="nf">fighter/all</span> <span class="p">{</span><span class="ss">:arena-id</span> <span class="nv">arena-id</span>&#x000A;                               <span class="ss">:hidden</span> <span class="p">{</span><span class="nv">$exists</span> <span class="nv">false</span><span class="p">}</span>&#x000A;                               <span class="ss">:image-extension</span> <span class="p">{</span><span class="nv">$exists</span> <span class="nv">true</span> <span class="nv">$ne</span> <span class="s">""</span><span class="p">}})]</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">count </span><span class="nv">fighters</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">some </span><span class="o">#</span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">empty?</span> <span class="p">(</span><span class="ss">:team</span> <span class="nv">%</span><span class="p">)))</span> <span class="nv">fighters</span><span class="p">)</span>&#x000A;        <span class="p">(</span><span class="nf">random-team-fighters</span> <span class="nv">fighters</span><span class="p">)</span>&#x000A;        <span class="p">(</span><span class="nf">random-teamless-fighters</span> <span class="nv">fighters</span><span class="p">))</span>&#x000A;      <span class="p">[])))</span>&#x000A;&#x000A;<span class="c1">;; Convert a battle record into the format we want to store in the session</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battle-&gt;session-battle</span> <span class="p">[</span><span class="nv">battle</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">shortname</span> <span class="p">(</span><span class="ss">:shortname</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">battle</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="nb">map </span><span class="ss">:_id</span> <span class="p">(</span><span class="ss">:fighters</span> <span class="nv">battle</span><span class="p">))</span> <span class="nv">shortname</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; Takes a seq of battles, which are a map of arena and two fighters</span>&#x000A;<span class="c1">;; for that arena. Save all battles in the session so that we know who</span>&#x000A;<span class="c1">;; the loser was when the user selects a winner.</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">register-battles!</span> <span class="p">[</span><span class="nv">b</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">battles-processed</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">hash-map</span>&#x000A;                                 <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">list </span><span class="nv">battle</span><span class="p">]</span>&#x000A;                                           <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">bs</span> <span class="p">(</span><span class="nf">battle-&gt;session-battle</span> <span class="nv">battle</span><span class="p">)]</span>&#x000A;                                             <span class="p">(</span><span class="nb">conj list </span><span class="p">(</span><span class="nb">first </span><span class="nv">bs</span><span class="p">)</span> <span class="nv">bs</span><span class="p">)))</span>&#x000A;                                         <span class="p">[]</span>&#x000A;                                         <span class="nv">b</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nf">session/put!</span> <span class="ss">:battles</span> <span class="nv">battles-processed</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">session/put!</span> <span class="ss">:main-battle</span> <span class="p">(</span><span class="nf">battle-&gt;session-battle</span> <span class="p">(</span><span class="nb">first </span><span class="nv">b</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">arena-&gt;battle</span> <span class="p">[</span><span class="nv">arena</span><span class="p">]</span>&#x000A;  <span class="p">{</span><span class="ss">:arena</span> <span class="nv">arena</span> <span class="ss">:fighters</span> <span class="p">(</span><span class="nf">random-fighters</span> <span class="p">(</span><span class="nf">arena/idstr</span> <span class="nv">arena</span><span class="p">))})</span>&#x000A;&#x000A;<span class="c1">;; Ensure that we only deal with displayable battles</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battle-filter</span> <span class="p">[</span><span class="nv">battles</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;= </span><span class="p">(</span><span class="nb">count </span><span class="p">(</span><span class="ss">:fighters</span> <span class="nv">%</span><span class="p">))</span> <span class="mi">2</span><span class="p">)</span> <span class="nv">battles</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; Arenas can be hidden through moderation</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">filtered-arenas</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">arena/all</span> <span class="p">{</span><span class="ss">:hidden</span> <span class="p">{</span><span class="nv">$exists</span> <span class="nv">false</span><span class="p">}}))</span>&#x000A;&#x000A;<span class="c1">;; If the main arena isn't specified we don't have to do anything</span>&#x000A;<span class="c1">;; special to ensure the order of the battles returned</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battles-without-main-arena-specified</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">battle-filter</span> <span class="p">(</span><span class="nb">map </span><span class="nv">arena-&gt;battle</span> <span class="p">(</span><span class="nf">filtered-arenas</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="c1">;; When the main arena is specified, then the battle in that arena</span>&#x000A;<span class="c1">;; needs to be at the head of the seq returned. This is because the</span>&#x000A;<span class="c1">;; battle partial designates the first battle as the "main" one</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battles-with-main-arena-specified</span> <span class="p">[</span><span class="nv">main-arena</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">arenas</span> <span class="p">(</span><span class="nb">remove </span><span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="nv">main-arena</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">filtered-arenas</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">battle-filter</span> <span class="p">(</span><span class="nb">map </span><span class="nv">arena-&gt;battle</span> <span class="nv">arenas</span><span class="p">)))</span> <span class="p">(</span><span class="nf">arena-&gt;battle</span> <span class="nv">main-arena</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="c1">;; This just calls one of the above two functions as appropriate and</span>&#x000A;<span class="c1">;; then registers the battles in the session</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battles</span> <span class="p">[</span><span class="nv">main-arena</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">b</span> <span class="p">(</span><span class="k">if </span><span class="nv">main-arena</span>&#x000A;            <span class="p">(</span><span class="nf">battles-with-main-arena-specified</span> <span class="nv">main-arena</span><span class="p">)</span>&#x000A;            <span class="p">(</span><span class="nf">battles-without-main-arena-specified</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nf">register-battles!</span> <span class="nv">b</span><span class="p">)</span>&#x000A;    <span class="nv">b</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;;----------</span>&#x000A;<span class="c1">;; Partials for battle page</span>&#x000A;<span class="c1">;;----------</span>&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">card</span> <span class="p">[</span><span class="nv">arena</span> <span class="nv">record</span> <span class="nv">img-version</span><span class="p">]</span>&#x000A;  <span class="p">[</span><span class="ss">:div.name</span> <span class="p">(</span><span class="ss">:name</span> <span class="nv">record</span><span class="p">)]</span>&#x000A;  <span class="p">[</span><span class="ss">:div.pic</span>&#x000A;   <span class="p">[</span><span class="ss">:a</span> <span class="p">{</span><span class="ss">:href</span> <span class="p">(</span><span class="nf">url-for-r</span> <span class="ss">:battles/winner</span> <span class="p">{</span><span class="ss">:_id</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">record</span><span class="p">)</span> <span class="ss">:arena-shortname</span> <span class="p">(</span><span class="ss">:shortname</span> <span class="nv">arena</span><span class="p">)})}</span>&#x000A;    <span class="p">(</span><span class="nf">fighters/fighter-img</span> <span class="nv">img-version</span> <span class="nv">record</span><span class="p">)]])</span>&#x000A;&#x000A;<span class="c1">;; I don't even remember what this is for</span>&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">card-without-battle</span> <span class="p">[</span><span class="nv">record</span> <span class="nv">img-version</span><span class="p">]</span>&#x000A;  <span class="p">[</span><span class="ss">:div.name</span> <span class="p">(</span><span class="ss">:name</span> <span class="nv">record</span><span class="p">)]</span>&#x000A;  <span class="p">[</span><span class="ss">:div.pic</span>&#x000A;   <span class="p">(</span><span class="nf">fighters/fighter-img</span> <span class="nv">img-version</span> <span class="nv">record</span><span class="p">)])</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">win-ratio</span> <span class="p">[</span><span class="nv">fighter</span> <span class="nv">wins</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">bouts</span> <span class="p">(</span><span class="nb">reduce + </span><span class="p">(</span><span class="nb">vals </span><span class="nv">wins</span><span class="p">))</span>&#x000A;        <span class="nv">_id</span> <span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="ss">:_id</span> <span class="nv">fighter</span><span class="p">))</span>&#x000A;        <span class="nv">ratio</span> <span class="p">(</span><span class="nb">* </span><span class="mi">100</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="nv">bouts</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nf">_id</span> <span class="nv">wins</span><span class="p">)</span> <span class="nv">bouts</span><span class="p">)))]</span>&#x000A;    <span class="p">[</span><span class="ss">:div.ratio-card</span>&#x000A;     <span class="p">(</span><span class="nf">card-without-battle</span>  <span class="nv">fighter</span> <span class="s">"card"</span><span class="p">)</span>&#x000A;     <span class="p">[</span><span class="ss">:div.win-ratio</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">format</span> <span class="s">"%.1f"</span> <span class="p">(</span><span class="nb">double </span><span class="nv">ratio</span><span class="p">))</span> <span class="s">"%"</span><span class="p">)]]))</span>&#x000A;&#x000A;<span class="c1">;; Minor battles are all the battles displayed after the "main" one at</span>&#x000A;<span class="c1">;; the top</span>&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">_minor-battle</span> <span class="p">[</span><span class="nv">battle</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">when </span><span class="nv">battle</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">left-f</span> <span class="nv">right-f</span><span class="p">]</span> <span class="p">(</span><span class="ss">:fighters</span> <span class="nv">battle</span><span class="p">)</span>&#x000A;          <span class="nv">arena</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">battle</span><span class="p">)]</span>&#x000A;      <span class="p">[</span><span class="ss">:div.battle</span>&#x000A;       <span class="p">[</span><span class="ss">:h2</span> <span class="p">(</span><span class="ss">:fight-text</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">battle</span><span class="p">))]</span>&#x000A;       <span class="p">[</span><span class="ss">:div.fighter.a</span> <span class="p">(</span><span class="nf">card</span> <span class="nv">arena</span> <span class="nv">left-f</span> <span class="s">"card"</span><span class="p">)]</span>&#x000A;       <span class="p">[</span><span class="ss">:div.fighter.b</span> <span class="p">(</span><span class="nf">card</span> <span class="nv">arena</span> <span class="nv">right-f</span> <span class="s">"card"</span><span class="p">)]])))</span>&#x000A;&#x000A;<span class="c1">;; Divide the minor battles into rows so that they show up correctly</span>&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">_minor-battle-row</span> <span class="p">[</span><span class="nv">row</span><span class="p">]</span>&#x000A;  <span class="p">[</span><span class="ss">:div.row</span>&#x000A;   <span class="p">(</span><span class="nb">map </span><span class="nv">_minor-battle</span> <span class="nv">row</span><span class="p">)])</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">_minor-battles</span> <span class="p">[</span><span class="nv">minor-battles</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">rows</span> <span class="p">(</span><span class="nf">partition</span> <span class="mi">2</span> <span class="mi">2</span> <span class="p">[</span><span class="nv">nil</span><span class="p">]</span> <span class="nv">minor-battles</span><span class="p">)]</span>&#x000A;    <span class="p">[</span><span class="ss">:div#minor-battles</span>&#x000A;     <span class="p">(</span><span class="nb">map </span><span class="nv">_minor-battle-row</span> <span class="nv">rows</span><span class="p">)]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">previous-battle-results</span> <span class="p">[</span><span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">and </span><span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">previous-fighters</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">fighter/one-by-id</span> <span class="nv">%</span><span class="p">)</span> <span class="p">[</span><span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">])</span>&#x000A;          <span class="nv">wins</span> <span class="p">(</span><span class="nf">battle/record-for-pair</span> <span class="p">(</span><span class="nb">map </span><span class="ss">:_id</span> <span class="nv">previous-fighters</span><span class="p">))]</span>&#x000A;      <span class="p">[</span><span class="ss">:div.win-ratios</span>&#x000A;       <span class="p">[</span><span class="ss">:h2</span> <span class="s">"Win Ratio"</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nf">win-ratio</span> <span class="p">(</span><span class="nb">first </span><span class="nv">previous-fighters</span><span class="p">)</span> <span class="nv">wins</span><span class="p">)</span>&#x000A;       <span class="p">(</span><span class="nf">win-ratio</span> <span class="p">(</span><span class="nb">second </span><span class="nv">previous-fighters</span><span class="p">)</span> <span class="nv">wins</span><span class="p">)])))</span>&#x000A;&#x000A;<span class="c1">;; This will display the main arena. Maybe it should be named main-arena</span>&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">main-area</span> <span class="p">[</span><span class="nv">arena</span> <span class="nv">left-f</span> <span class="nv">right-f</span><span class="p">]</span>&#x000A;  <span class="p">[</span><span class="ss">:div#battle</span>&#x000A;   <span class="p">[</span><span class="ss">:div.fighter.a</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="nv">left-f</span> <span class="p">(</span><span class="nf">card</span> <span class="nv">arena</span> <span class="nv">left-f</span> <span class="s">"battle"</span><span class="p">))]</span>&#x000A;   <span class="p">[</span><span class="ss">:div.fighter.b</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="nv">right-f</span> <span class="p">(</span><span class="nf">card</span> <span class="nv">arena</span> <span class="nv">right-f</span> <span class="s">"battle"</span><span class="p">))]])</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">battle</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">prev-fighter-id-a</span>&#x000A;                            <span class="nv">prev-fighter-id-b</span>&#x000A;                            <span class="nv">prev-main-arena-shortname</span>&#x000A;                            <span class="nv">main-arena-shortname</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">designated-main-battle</span> <span class="p">(</span><span class="nb">when </span><span class="nv">main-arena-shortname</span> <span class="p">(</span><span class="nf">arena/one</span> <span class="p">{</span><span class="ss">:shortname</span> <span class="nv">main-arena-shortname</span><span class="p">}))</span>&#x000A;        <span class="p">[</span><span class="nv">main-battle</span> <span class="o">&amp;</span> <span class="nv">minor-battles</span><span class="p">]</span> <span class="p">(</span><span class="nf">battles</span> <span class="nv">designated-main-battle</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="nv">main-battle</span>&#x000A;      <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">left-f</span> <span class="nv">right-f</span><span class="p">]</span> <span class="p">(</span><span class="ss">:fighters</span> <span class="nv">main-battle</span><span class="p">)</span>&#x000A;            <span class="nv">arena</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">main-battle</span><span class="p">)]</span>&#x000A;        <span class="p">(</span><span class="nf">common/layout</span> &#x000A;         <span class="p">[</span><span class="ss">:h1</span> <span class="p">(</span><span class="ss">:fight-text</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">main-battle</span><span class="p">))]</span>&#x000A;         <span class="p">[</span><span class="ss">:div#battles</span>&#x000A;          <span class="p">(</span><span class="nf">main-area</span> <span class="nv">arena</span> <span class="nv">left-f</span> <span class="nv">right-f</span><span class="p">)</span>&#x000A;          <span class="p">(</span><span class="nf">_minor-battles</span> <span class="nv">minor-battles</span><span class="p">)]</span>&#x000A;         <span class="p">[</span><span class="ss">:div#secondary</span>&#x000A;          <span class="p">(</span><span class="nf">previous-battle-results</span> <span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">)])))))</span>&#x000A;&#x000A;<span class="c1">;; This is used to convert the data stored in a session for a battle</span>&#x000A;<span class="c1">;; into something usable by the battle partial</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">session-battle-&gt;battle-map</span> <span class="p">[</span><span class="nv">session-battle</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">prev-main-arena-shortname</span> <span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">]</span> <span class="nv">session-battle</span><span class="p">]</span>&#x000A;    <span class="p">{</span><span class="ss">:prev-main-arena-shortname</span> <span class="nv">prev-main-arena-shortname</span>&#x000A;     <span class="ss">:prev-fighter-id-a</span> <span class="nv">prev-fighter-id-a</span>&#x000A;     <span class="ss">:prev-fighter-id-b</span> <span class="nv">prev-fighter-id-b</span><span class="p">}))</span>&#x000A;&#x000A;<span class="c1">;; The home page. Show completely random battles</span>&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">listing</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">battle</span> <span class="p">(</span><span class="nf">session-battle-&gt;battle-map</span> <span class="p">(</span><span class="nf">session/get</span> <span class="ss">:main-battle</span><span class="p">))))</span>&#x000A;&#x000A;<span class="c1">;; When a user clicks on an image, determine which battle it's from so</span>&#x000A;<span class="c1">;; that you can record the winner and show that battle's arena in the</span>&#x000A;<span class="c1">;; main area</span>&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">winner</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">arena-shortname</span> <span class="nv">_id</span><span class="p">]}</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">selected-battle</span> <span class="p">((</span><span class="nf">session/get</span> <span class="ss">:battles</span><span class="p">)</span> <span class="nv">arena-shortname</span><span class="p">)</span>&#x000A;        <span class="nv">selected-battle-fighter-ids</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">selected-battle</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">battle/record-winner!</span> <span class="nv">selected-battle-fighter-ids</span> <span class="nv">_id</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">battle-map</span> <span class="p">(</span><span class="nf">session-battle-&gt;battle-map</span> <span class="p">(</span><span class="nb">or </span><span class="nv">selected-battle</span> <span class="p">(</span><span class="nf">session/get</span> <span class="ss">:main-battle</span><span class="p">)))]</span>&#x000A;      <span class="p">(</span><span class="nf">battle</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">battle-map</span> <span class="ss">:main-arena-shortname</span> <span class="p">(</span><span class="ss">:prev-main-arena-shortname</span> <span class="nv">battle-map</span><span class="p">))))))</span>&#x000A;&#x000A;<span class="c1">;; When you want to show a specific arena</span>&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">arena</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">shortname</span><span class="p">]}</span>&#x000A;  <span class="p">(</span><span class="nf">battle</span> <span class="p">{</span><span class="ss">:main-arena-shortname</span> <span class="nv">shortname</span><span class="p">}))</span></pre></div>
          <h3>Choosing the "main" arena</h3>
          
          <p>There are three different ways in which the "main" arena - the large one at the top - is chosen:</p>
          
          <ul>
          <li>You're viewing the home page, "/". The main arena should be completely random.</li>
          <li>You've just clicked an image (any image) as the winner of an
          arena. The main arena should be the one which the fighter you
          clicked on belongs to.</li>
          <li>You're viewing an arena directly, "/arenas/arena-name". Example:
          <a href="http://omgsmackdown.com/arenas/republicans-vs-monsters">Which creature is scarier?</a>. This
          is so that users can directly share an arena they've created or
          like.</li>
          </ul>
          
          <p>Additionally, whenever the page is refreshed it's necessary to show
          the winner of the previous main arena. All of this is accomplished by
          defining a partial which takes the main arena and previous fighters as
          parameters, along with page definitions which send the required info:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nf">defpartial</span> <span class="nv">battle</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">prev-fighter-id-a</span>&#x000A;                            <span class="nv">prev-fighter-id-b</span>&#x000A;                            <span class="nv">prev-main-arena-shortname</span>&#x000A;                            <span class="nv">main-arena-shortname</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">designated-main-battle</span> <span class="p">(</span><span class="nb">when </span><span class="nv">main-arena-shortname</span> <span class="p">(</span><span class="nf">arena/one</span> <span class="p">{</span><span class="ss">:shortname</span> <span class="nv">main-arena-shortname</span><span class="p">}))</span>&#x000A;        <span class="p">[</span><span class="nv">main-battle</span> <span class="o">&amp;</span> <span class="nv">minor-battles</span><span class="p">]</span> <span class="p">(</span><span class="nf">battles</span> <span class="nv">designated-main-battle</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="nv">main-battle</span>&#x000A;      <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">left-f</span> <span class="nv">right-f</span><span class="p">]</span> <span class="p">(</span><span class="ss">:fighters</span> <span class="nv">main-battle</span><span class="p">)</span>&#x000A;            <span class="nv">arena</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">main-battle</span><span class="p">)]</span>&#x000A;        <span class="p">(</span><span class="nf">common/layout</span> &#x000A;         <span class="p">[</span><span class="ss">:h1</span> <span class="p">(</span><span class="ss">:fight-text</span> <span class="p">(</span><span class="ss">:arena</span> <span class="nv">main-battle</span><span class="p">))]</span>&#x000A;         <span class="p">[</span><span class="ss">:div#battles</span>&#x000A;          <span class="p">(</span><span class="nf">main-area</span> <span class="nv">arena</span> <span class="nv">left-f</span> <span class="nv">right-f</span><span class="p">)</span>&#x000A;          <span class="p">(</span><span class="nf">_minor-battles</span> <span class="nv">minor-battles</span><span class="p">)]</span>&#x000A;         <span class="p">[</span><span class="ss">:div#secondary</span>&#x000A;          <span class="p">(</span><span class="nf">previous-battle-results</span> <span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">)])))))</span>&#x000A;&#x000A;<span class="c1">;; This is used to convert the data stored in a session for a battle</span>&#x000A;<span class="c1">;; into something usable by the battle partial</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">session-battle-&gt;battle-map</span> <span class="p">[</span><span class="nv">session-battle</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">prev-main-arena-shortname</span> <span class="nv">prev-fighter-id-a</span> <span class="nv">prev-fighter-id-b</span><span class="p">]</span> <span class="nv">session-battle</span><span class="p">]</span>&#x000A;    <span class="p">{</span><span class="ss">:prev-main-arena-shortname</span> <span class="nv">prev-main-arena-shortname</span>&#x000A;     <span class="ss">:prev-fighter-id-a</span> <span class="nv">prev-fighter-id-a</span>&#x000A;     <span class="ss">:prev-fighter-id-b</span> <span class="nv">prev-fighter-id-b</span><span class="p">}))</span>&#x000A;&#x000A;<span class="c1">;; The home page. Show completely random battles</span>&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">listing</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">battle</span> <span class="p">(</span><span class="nf">session-battle-&gt;battle-map</span> <span class="p">(</span><span class="nf">session/get</span> <span class="ss">:main-battle</span><span class="p">))))</span>&#x000A;&#x000A;<span class="c1">;; When a user clicks on an image, determine which battle it's from so</span>&#x000A;<span class="c1">;; that you can record the winner and show that battle's arena in the</span>&#x000A;<span class="c1">;; main area</span>&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">winner</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">arena-shortname</span> <span class="nv">_id</span><span class="p">]}</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">selected-battle</span> <span class="p">((</span><span class="nf">session/get</span> <span class="ss">:battles</span><span class="p">)</span> <span class="nv">arena-shortname</span><span class="p">)</span>&#x000A;        <span class="nv">selected-battle-fighter-ids</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">selected-battle</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">battle/record-winner!</span> <span class="nv">selected-battle-fighter-ids</span> <span class="nv">_id</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">battle-map</span> <span class="p">(</span><span class="nf">session-battle-&gt;battle-map</span> <span class="p">(</span><span class="nb">or </span><span class="nv">selected-battle</span> <span class="p">(</span><span class="nf">session/get</span> <span class="ss">:main-battle</span><span class="p">)))]</span>&#x000A;      <span class="p">(</span><span class="nf">battle</span> <span class="p">(</span><span class="nb">assoc </span><span class="nv">battle-map</span> <span class="ss">:main-arena-shortname</span> <span class="p">(</span><span class="ss">:prev-main-arena-shortname</span> <span class="nv">battle-map</span><span class="p">))))))</span>&#x000A;&#x000A;<span class="c1">;; When you want to show a specific arena</span>&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">arena</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">shortname</span><span class="p">]}</span>&#x000A;  <span class="p">(</span><span class="nf">battle</span> <span class="p">{</span><span class="ss">:main-arena-shortname</span> <span class="nv">shortname</span><span class="p">}))</span></pre></div>
          <h3>Randomizing arena order</h3>
          
          <p>Arena randomization is handled with these functions:</p>
          <div class="highlight"><pre><span class="c1">;; Ensure that we only deal with displayable battles</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battle-filter</span> <span class="p">[</span><span class="nv">battles</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">&gt;= </span><span class="p">(</span><span class="nb">count </span><span class="p">(</span><span class="ss">:fighters</span> <span class="nv">%</span><span class="p">))</span> <span class="mi">2</span><span class="p">)</span> <span class="nv">battles</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; Arenas can be hidden through moderation</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">filtered-arenas</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">arena/all</span> <span class="p">{</span><span class="ss">:hidden</span> <span class="p">{</span><span class="nv">$exists</span> <span class="nv">false</span><span class="p">}}))</span>&#x000A;&#x000A;<span class="c1">;; If the main arena isn't specified we don't have to do anything</span>&#x000A;<span class="c1">;; special to ensure the order of the battles returned</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battles-without-main-arena-specified</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">battle-filter</span> <span class="p">(</span><span class="nb">map </span><span class="nv">arena-&gt;battle</span> <span class="p">(</span><span class="nf">filtered-arenas</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="c1">;; When the main arena is specified, then the battle in that arena</span>&#x000A;<span class="c1">;; needs to be at the head of the seq returned. This is because the</span>&#x000A;<span class="c1">;; battle partial designates the first battle as the "main" one</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battles-with-main-arena-specified</span> <span class="p">[</span><span class="nv">main-arena</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">arenas</span> <span class="p">(</span><span class="nb">remove </span><span class="o">#</span><span class="p">(</span><span class="nb">= </span><span class="nv">main-arena</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="nf">filtered-arenas</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">battle-filter</span> <span class="p">(</span><span class="nb">map </span><span class="nv">arena-&gt;battle</span> <span class="nv">arenas</span><span class="p">)))</span> <span class="p">(</span><span class="nf">arena-&gt;battle</span> <span class="nv">main-arena</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="c1">;; This just calls one of the above two functions as appropriate and</span>&#x000A;<span class="c1">;; then registers the battles in the session</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">battles</span> <span class="p">[</span><span class="nv">main-arena</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">b</span> <span class="p">(</span><span class="k">if </span><span class="nv">main-arena</span>&#x000A;            <span class="p">(</span><span class="nf">battles-with-main-arena-specified</span> <span class="nv">main-arena</span><span class="p">)</span>&#x000A;            <span class="p">(</span><span class="nf">battles-without-main-arena-specified</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nf">register-battles!</span> <span class="nv">b</span><span class="p">)</span>&#x000A;    <span class="nv">b</span><span class="p">))</span></pre></div>
          <p>The <code>battles-with-main-arena-specified</code> function looks kind of goofy to me. It's weird to remove the main arena, shuffle the rest, then add the main arena back in, but maybe that's fine.</p>
          
          <h3>Randomizing Fighters</h3>
          <div class="highlight"><pre><span class="c1">;; When there are no teams, it's everybody against everybody</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">random-teamless-fighters</span> <span class="p">[</span><span class="nv">fighters</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">randomer</span> <span class="o">#</span><span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">count </span><span class="nv">fighters</span><span class="p">))</span>&#x000A;        <span class="nb">left </span><span class="p">(</span><span class="nf">randomer</span><span class="p">)</span>&#x000A;        <span class="nb">right </span><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="nv">%</span> <span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">randomer</span><span class="p">)))]</span>&#x000A;    <span class="p">[(</span><span class="nb">nth </span><span class="nv">fighters</span> <span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nb">nth </span><span class="nv">fighters</span> <span class="nv">right</span><span class="p">)]))</span>&#x000A;&#x000A;<span class="c1">;; When we're dealing with an arena that has teams, we need to ensure</span>&#x000A;<span class="c1">;; that we don't pit two fighters from the same team against each other</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">random-team-fighters</span> <span class="p">[</span><span class="nv">fighters</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">randomer</span> <span class="o">#</span><span class="p">(</span><span class="nb">nth </span><span class="nv">fighters</span> <span class="p">(</span><span class="nb">rand-int </span><span class="p">(</span><span class="nb">count </span><span class="nv">fighters</span><span class="p">)))</span>&#x000A;        <span class="nb">left </span><span class="p">(</span><span class="nf">randomer</span><span class="p">)</span>&#x000A;        <span class="nb">right </span><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">filter </span><span class="o">#</span><span class="p">(</span><span class="nb">not= </span><span class="p">(</span><span class="ss">:team</span> <span class="nv">%</span><span class="p">)</span> <span class="p">(</span><span class="ss">:team</span> <span class="nv">left</span><span class="p">))</span> <span class="p">(</span><span class="nf">repeatedly</span> <span class="nv">randomer</span><span class="p">)))]</span>&#x000A;    <span class="p">[</span><span class="nb">left </span><span class="nv">right</span><span class="p">]))</span></pre></div>
          <h2>Account Creation</h2>
          
          <p>Holy crap, this article is so freaking long. Anyway, noir's validation
          helpers really helped out when I wrote account creation:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.views.users</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.views.common</span> <span class="ss">:as</span> <span class="nv">common</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.data-mappers.user</span> <span class="ss">:as</span> <span class="nv">user</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.models.permissions</span> <span class="ss">:as</span> <span class="nv">can</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">noir.session</span> <span class="ss">:as</span> <span class="nv">session</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">noir.response</span> <span class="ss">:as</span> <span class="nv">res</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">cemerick.friend</span> <span class="ss">:as</span> <span class="nv">friend</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">cemerick.friend.workflows</span> <span class="ss">:as</span> <span class="nv">workflows</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">noir.validation</span> <span class="ss">:as</span> <span class="nv">vali</span><span class="p">])</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:use</span> <span class="nv">noir.core</span>&#x000A;        <span class="nv">hiccup.core</span>&#x000A;        <span class="nv">hiccup.form-helpers</span>&#x000A;        <span class="nv">arenaverse.views.routes</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">valid?</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">username</span> <span class="nv">password</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="nf">vali/rule</span> <span class="p">(</span><span class="nf">vali/min-length?</span> <span class="nv">username</span> <span class="mi">4</span><span class="p">)</span>&#x000A;             <span class="p">[</span><span class="ss">:username</span> <span class="s">"Your username must be at least 4 characters"</span><span class="p">])</span>&#x000A;  <span class="p">(</span><span class="nf">vali/rule</span> <span class="p">(</span><span class="nb">nil? </span><span class="p">(</span><span class="nf">user/one</span> <span class="p">{</span><span class="ss">:username</span> <span class="nv">username</span><span class="p">}))</span>&#x000A;             <span class="p">[</span><span class="ss">:username</span> <span class="s">"That username is already taken :("</span><span class="p">])</span>&#x000A;  <span class="p">(</span><span class="nf">vali/rule</span> <span class="p">(</span><span class="nf">vali/min-length?</span> <span class="nv">password</span> <span class="mi">4</span><span class="p">)</span>&#x000A;             <span class="p">[</span><span class="ss">:password</span> <span class="s">"Your password must be at least 4 characters"</span><span class="p">])</span>&#x000A;  <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nf">vali/errors?</span> <span class="ss">:username</span> <span class="ss">:password</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpartial</span> <span class="nv">error-item</span> <span class="p">[[</span><span class="nv">first-error</span><span class="p">]]</span>&#x000A;  <span class="p">[</span><span class="ss">:p.error</span> <span class="nv">first-error</span><span class="p">])</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">shiny</span> <span class="p">{</span><span class="ss">:as</span> <span class="nv">user</span><span class="p">}</span>&#x000A;  <span class="p">(</span><span class="nf">common/layout</span>&#x000A;   <span class="p">[</span><span class="ss">:h1</span> <span class="s">"Sign Up!"</span><span class="p">]</span>&#x000A;   <span class="p">[</span><span class="ss">:p</span> <span class="s">"Wow, you are about to make one of the best decisions of your life. Congratulations!"</span><span class="p">]</span>&#x000A;   <span class="p">(</span><span class="nf">form-to</span> <span class="p">[</span><span class="ss">:post</span> <span class="p">(</span><span class="nf">url-for-r</span> <span class="ss">:users/create</span><span class="p">)]</span>&#x000A;            <span class="p">[</span><span class="ss">:div</span>&#x000A;             <span class="p">[</span><span class="ss">:div.control-group</span>&#x000A;              <span class="p">(</span><span class="nf">vali/on-error</span> <span class="ss">:username</span> <span class="nv">error-item</span><span class="p">)</span>&#x000A;              <span class="p">(</span><span class="nf">label</span> <span class="s">"username"</span> <span class="s">"Username"</span><span class="p">)</span>&#x000A;              <span class="p">[</span><span class="ss">:span.help</span> <span class="s">"Must be at least 4 characters"</span><span class="p">]</span>&#x000A;              <span class="p">[</span><span class="ss">:div.controls</span> <span class="p">(</span><span class="nf">text-field</span> <span class="s">"username"</span> <span class="p">(</span><span class="ss">:username</span> <span class="nv">user</span><span class="p">))]]</span>&#x000A;             <span class="p">[</span><span class="ss">:div.control-group</span>&#x000A;              <span class="p">(</span><span class="nf">vali/on-error</span> <span class="ss">:password</span> <span class="nv">error-item</span><span class="p">)</span>&#x000A;              <span class="p">(</span><span class="nf">label</span> <span class="s">"password"</span> <span class="s">"Password"</span><span class="p">)</span>&#x000A;              <span class="p">[</span><span class="ss">:span.help</span> <span class="s">"Must be at least 4 characters"</span><span class="p">]</span>&#x000A;              <span class="p">[</span><span class="ss">:div.controls</span> <span class="p">(</span><span class="nf">password-field</span> <span class="s">"password"</span><span class="p">)]]</span>&#x000A;             <span class="p">[</span><span class="ss">:div.form-controls</span> <span class="p">(</span><span class="nf">submit-button</span> <span class="s">"Sign Up"</span><span class="p">)]])))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">register</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">uri</span> <span class="nv">request-method</span> <span class="nv">params</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">= </span><span class="nv">uri</span> <span class="s">"/users"</span><span class="p">)</span>&#x000A;             <span class="p">(</span><span class="nb">= </span><span class="nv">request-method</span> <span class="ss">:post</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">valid?</span> <span class="nv">params</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="nf">workflows/make-auth</span> <span class="p">(</span><span class="nf">user/create</span> <span class="nv">params</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defpage-r</span> <span class="nv">create</span> <span class="p">{</span><span class="ss">:as</span> <span class="nv">user</span><span class="p">}</span>&#x000A;  <span class="p">(</span><span class="nf">render</span> <span class="nv">users-shiny</span> <span class="nv">user</span><span class="p">))</span></pre></div>
          <p>All that <code>valid?</code> and <code>vali/on-error</code> stuff is pretty much straight
          from the tutorial. So much so that I actually have that <code>error-item</code>
          partial copied and pasted all over my code, which is kind of crappy
          but which is also something that's easily fixable.</p>
          
          <p>You may be wondering what the <code>register</code> function is doing there. I'll
          get into that in the next section.</p>
          
          <h2>Authentication with friend</h2>
          
          <p><a href="https://github.com/cemerick/friend">cemerick's friend</a> library seems
          to be fairly popular. I found it a little confusing to work with so
          hopefully these notes help other Clojurists making other, less
          ridiculous web sites.</p>
          
          <h3>Logging in automatically after creating an account</h3>
          
          <p>In order to log a user in automatically after creating an account, I
          had to create a custom workflow. Here's the friend code:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nf">server/add-middleware</span>&#x000A; <span class="nv">friend/authenticate</span> &#x000A; <span class="p">{</span><span class="ss">:credential-fn</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">creds/bcrypt-credential-fn</span> <span class="nv">credential-fn</span><span class="p">)</span>&#x000A;  <span class="ss">:workflows</span> <span class="p">[(</span><span class="nf">workflows/interactive-form</span><span class="p">)</span>, <span class="nv">arenaverse.views.users/register</span>, <span class="nv">session-store-authorize</span><span class="p">]</span>&#x000A;  <span class="ss">:login-uri</span> <span class="s">"/login"</span>&#x000A;  <span class="ss">:unauthorized-redirect-uri</span> <span class="s">"/login"</span> &#x000A;  <span class="ss">:default-landing-uri</span> <span class="s">"/admin"</span><span class="p">})</span></pre></div>
          <p><code>arenaverse.views.users/register</code> handles the login, which made this
          weird because had to require view functions within my <code>server.clj</code>
          file. This felt pretty wrong. Anyway, here's the register function:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">register</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">uri</span> <span class="nv">request-method</span> <span class="nv">params</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">= </span><span class="nv">uri</span> <span class="s">"/users"</span><span class="p">)</span>&#x000A;             <span class="p">(</span><span class="nb">= </span><span class="nv">request-method</span> <span class="ss">:post</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">valid?</span> <span class="nv">params</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="nf">workflows/make-auth</span> <span class="p">(</span><span class="nf">user/create</span> <span class="nv">params</span><span class="p">)))))</span></pre></div>
          <p>Looking at this now, it's hard to even reason out what's going on and
          how it relates to the friend library. I think what's happening though
          is that this function is called by the friend
          "middleware":https://github.com/ring-clojure/ring on every single
          request. It's therefore necessary to specify that its logic should
          only be run when the given criteria are met.</p>
          
          <p>When the criteria are met - when the user posts to <code>/users</code> - then the
          function checks to see if the params are valid. If they are then
          friend's <code>workflows/make-auth</code> function is called with the result of
          <code>user/create</code> (remember how I elaborated on that above?). This
          function does some session magic or something. From then on friend
          considers you logged in.</p>
          
          <p>If the params are invalid, then nil is returned and your request gets
          processed like it normally would. This means that the <code>create</code> page
          gets called, which in turn renders <code>shiny</code>. Since your params are
          invalid, error messages will show up.</p>
          
          <h3>Remaining logged in when the server restarts</h3>
          
          <p>Another issue with friend is that your session data isn't stored in a
          cookie. Therefore, every time heroku spins the app down you get logged
          out. This is problematic because there's no password recovery
          functionality and also because it's just lame.</p>
          
          <p>To resolve this I did the following:</p>
          
          <ol>
          <li>
          <p>Use clojure-monger's session store function to persist session info to mongodb:</p>
          <div class="highlight"><pre>  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">monger.ring.session-store</span> <span class="ss">:only</span> <span class="p">(</span><span class="nf">session-store</span><span class="p">)]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">server/load-views</span> <span class="s">"src/arenaverse/views/"</span><span class="p">)</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">m</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">mode</span> <span class="p">(</span><span class="nb">keyword </span><span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nb">first </span><span class="nv">m</span><span class="p">)</span> <span class="ss">:dev</span><span class="p">))</span>&#x000A;        <span class="nv">port</span> <span class="p">(</span><span class="nf">Integer.</span> <span class="p">(</span><span class="nb">get </span><span class="p">(</span><span class="nf">System/getenv</span><span class="p">)</span> <span class="s">"PORT"</span> <span class="s">"8080"</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">uri</span> <span class="p">(</span><span class="nb">get </span><span class="p">(</span><span class="nf">System/getenv</span><span class="p">)</span> <span class="s">"MONGOLAB_URI"</span> <span class="p">(</span><span class="nb">str </span><span class="s">"mongodb://127.0.0.1/omgsmackdown-"</span> <span class="p">(</span><span class="nb">name </span><span class="nv">mode</span><span class="p">)))]</span>&#x000A;      <span class="p">(</span><span class="nf">monger.core/connect-via-uri!</span> <span class="nv">uri</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="nf">server/start</span> <span class="nv">port</span> <span class="p">{</span><span class="ss">:mode</span> <span class="nv">mode</span>&#x000A;                        <span class="ss">:ns</span> <span class="ss">'arenaverse</span>&#x000A;                        <span class="ss">:session-store</span> <span class="p">(</span><span class="nf">session-store</span><span class="p">)})))</span></pre></div>
          </li>
          <li><p>Create a session-store-authorize workflow function</p></li>
          </ol>
          <div class="highlight"><pre>    <span class="p">(</span><span class="kd">defn </span><span class="nv">session-store-authorize</span> <span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">uri</span> <span class="nv">request-method</span> <span class="nv">params</span> <span class="nv">session</span><span class="p">]}]</span>&#x000A;      <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">nil? </span><span class="p">(</span><span class="ss">:cemerick.friend/identity</span> <span class="nv">session</span><span class="p">))</span>&#x000A;        <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">username</span> <span class="p">(</span><span class="nf">noir-session/get</span> <span class="ss">:username</span><span class="p">)]</span>&#x000A;          <span class="p">(</span><span class="nf">workflows/make-auth</span> <span class="p">(</span><span class="nf">user/one</span> <span class="p">{</span><span class="ss">:username</span> <span class="nv">username</span><span class="p">})))))</span></pre></div>
          <ol>
          <li>Add the workflow when adding the <code>friend/authenticate</code> middleware, which you can see above.</li>
          </ol>
          
          <h3>Overall Friend Confusion</h3>
          
          <p>I have to admit that I don't fully get sessions/cookies/auth in
          Clojure. With friend &amp; noir, I think the difficulty lies in the fact
          that friend is meant to work directly with ring, whereas noir provides
          a little magic on top of ring.</p>
          
          <p>If I understand correctly, ring sessions are perpetuated in a kind of
          repeating reduce, where the session data for one request is sent to a
          function. The function then transforms the data, and that's used for
          the next request. I don't know if I'm explaining it well but I think
          the key thing is that the session data is never requested and state is
          never modified.</p>
          
          <p>Noir, on the other hand, somehow stores session data by modifying
          state. So noir's session and the session variables created by friend
          exist in two totally different places.</p>
          
          <p>The other way in which noir's "magic" can cause confusion is that, by
          default, you don't have to care about ring and middlewares. So when
          you do have to care about middleware, like with ring, it's hard to
          visualize where it's coming into play and how it's interacting with
          your other routes.</p>
          
          <h2>Admining &amp; Moderating</h2>
          
          <p>OK this article really is too long now. Check out <code>models/permissions</code>
          and everything under <code>views/admin</code> and <code>views/moderate</code> to see what's
          going on.</p>
          
          <h2>Handling Stylesheets</h2>
          
          <p>You can see my source files in <code>resources/compass</code> in the git
          repo. Basically, I ran <code>compass watch</code> while doing
          development. Compass, Sass, and Susy are all great libraries for
          making good-looking sites. I made the logo with photoshop.</p>
          
          <h2>Final Thoughts</h2>
          
          <p>This was my first web site using Clojure and Noir. I've been using Rails for almost 7 years now, and there was a lot for me to get used to. Here's some stuff I liked:</p>
          
          <ul>
          <li>Clojure is awesome. It's a powerful lisp, and having access to Java makes it that much more powerful. Java was used for:
          
          <ul>
          <li>Processing images</li>
          <li>Uploading to S3</li>
          <li>Interacting with MongoDB</li>
          </ul>
          </li>
          <li>I really enjoyed being so close to the "metal"
          
          <ul>
          <li>Creating my own data-mapper abomination thing was quite fun</li>
          <li>The lack of magic felt freeing. I felt like I was only using what I needed, and that made my life a lot easier. I really don't know how else to describe that.</li>
          </ul>
          </li>
          <li>It was fun to make something so ridiculous.</li>
          </ul>
          
          <p>The only major drawback is the lack of libraries compared to
          Rails. For the time being, I'll continue reaching for Rails for
          professional work but I'll definitely use Clojure for my own side
          projects.</p>
          
          <p>Wow, so that's it! I hope you liked this detailed look at the silliest
          Clojure/Noir web site ever made! And if you like the site, please feel
          free to copy and it and do whatever you want with it. It'd be awesome
          to hear about it being installed on intranets with battles like "Which
          employee would win a drinking contest?"</p>
          <p>
            <a class='twitter-share-button' data-via='nonrecursive' href='https://twitter.com/share'>Tweet</a>
          </p>
          <script>
            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs')
          </script>
          <h2>Comments</h2>
          <div id='disqus_thread'></div>
          <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'flyingmachinestudios'; // required: replace example with your forum shortname
            
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
        </div>
      </div>
      <div id='nav'>
        <div class='articles'>
          <h2>Popular Blog Posts</h2>
          <ol>
            <li>
              <a class='title' href='/programming/the-unofficial-guide-to-rich-hickeys-brain/'>The Unofficial Guide to Rich Hickey's Brain</a>
            </li>
            <li>
              <a class='title' href='/programming/datomic-for-five-year-olds/'>Datomic for Five-Year-Olds</a>
            </li>
            <li>
              <a class='title' href='/programming/how-clojure-babies-are-made-lein-run/'>How Clojure Babies Are Made: Understanding lein run</a>
            </li>
          </ol>
          <h2>Recent Blog Posts</h2>
          <ol>
            <li>
              <a class='title' href='/programming/why-programmers-need-frameworks/'>Frameworks and Why (Clojure) Programmers Need Them</a>
            </li>
            <li>
              <a class='title' href='/people/buddy-system/'>Buddy Systems at Work: a Framework for Rewarding Relationships on Remote Teams</a>
            </li>
            <li>
              <a class='title' href='/programming/learn-programming-languages-efficiently/'>Techniques for Efficiently Learning Programming Languages</a>
            </li>
            <li>
              <a class='title' href='/essays/zen-joker/'>Zen and the Art of Blowing Things Up</a>
            </li>
            <li>
              <a class='title' href='/essays/process/'>My Writing Process</a>
            </li>
            <li>
              <a class='title' href='/programming/recursion/'>Understanding Recursion</a>
            </li>
            <li>
              <a class='title' href='/programming/timeless-tools/'>Timeless Programming Tools</a>
            </li>
          </ol>
        </div>
        <div class='projects'>
          <h2>Projects</h2>
          <ol>
            <li id='cftbat'>
              <header>
                <a href='http://braveclojure.com'>
                  Clojure for the Brave and True
                </a>
                <p>A goofy book for learning Clojure. No functional programming or Java experience required!</p>
              </header>
            </li>
            <li id='cuym'>
              <header>
                <a href='http://www.visualmess.com'>
                  Clean Up Your Mess: a Guide to Visual Design for Everyone
                </a>
              </header>
              <p>
                This popular guide will help you
                communicate with conscious skill. It will show you
                how to create designs that are easy to understand
                and attractive.
              </p>
            </li>
            <li id='gratefulplace'>
              <header>
                <a href='http://gratefulplace.com'>
                  Grateful Place
                </a>
              </header>
              <p>When we appreciate the good in our lives, the good grows and we have more of it.</p>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-666015-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
