<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    </meta>
    <title>Refactoring to Datamappers Clojure</title>
    <link href='/stylesheets/main.css?4' media='screen' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Ruthie|Gentium+Book+Basic:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/pygments.css?3' media='screen' rel='stylesheet' type='text/css'>
    <link href='http://feeds.feedburner.com/FlyingMachineStudios' rel='alternate' type='application/rss+xml'>
  </head>
  <body>
    <header class='top'>
      <div class='display'>
        <div class='title'>
          <a href='/'>Flying Machine Studios</a>
        </div>
        <div class='subtitle'>
          adventures in making stuff with Daniel Higginbotham
        </div>
      </div>
    </header>
    <div id='document'>
      <div id='contact'>
        <ul>
          <li>
            <a href='http://twitter.com/nonrecursive'>
              <i class='fa fa-twitter'></i>
            </a>
          </li>
          <li>
            <a href='http://www.linkedin.com/in/danielhigginbotham'>
              <i class='fa fa-linkedin'></i>
            </a>
          </li>
          <li>
            <a href='https://github.com/flyingmachine'>
              <i class='fa fa-github'></i>
            </a>
          </li>
          <li>
            <a href='http://feeds.feedburner.com/FlyingMachineStudios'>
              <i class='fa fa-rss'></i>
            </a>
          </li>
        </ul>
      </div>
      <div id='main'>
        <div class='page' id='content'>
          <h1>Refactoring to Datamappers Clojure</h1>
          <div class='date'>06 July 2012</div>
          <p>In this post I give a detailed description of a recent refactoring for
          my site <a href="http://omgsmackdown.com">"OMG! SMACKDOWN!!!"</a>. I make no
          attempt to enliven the article with "cats" or "memes" or "humor" -
          it's straight up code and commentary.</p>
          
          <p>The refactoring was largely influenced by Rich Hickey's talk
          <a href="http://www.confreaks.com/videos/860-railsconf2012-keynote-simplicity-matters">"Simplicity Matters"</a>. The
          main purposes were:</p>
          
          <ul>
          <li>Reduce complexity in the Hickeysian sense - untangle bits of code
          that don't need to be tangled together</li>
          <li>Introduce an explicit
          <a href="http://www.flyingmachinestudios.com/design/anatomy-of-frustration/">"design"</a>
          </li>
          <li>Reduce repetition</li>
          </ul>
          
          <p>In order to do this, I kept the following guidelines in mind:</p>
          
          <ul>
          <li>Create clear separation between data and the functions which transform them</li>
          <li>Reduce coupling through information and implementation hiding</li>
          <li>Abstract out the "bones" of functionality</li>
          </ul>
          
          <p>In the process I may have created an even more terrible monster than
          the one I started with and perhaps lost a few
          <a href="http://amzn.to/1H7NJ5e">"sanity points"</a> but the process was fun and
          educational.</p>
          
          <h2>Quick Project Overview</h2>
          
          <p><a href="http://omgsmackdown.com/">"OMG! SMACKDOWN!!!"</a>, perhaps one of the
          most important web sites in Internet history, is a
          <a href="http://webnoir.org/">"Noir"</a> project which allows users (well, just me
          for now) to create <code>arenas</code> wherein <code>fighters</code> <code>battle</code> it out.</p>
          
          <p>The project code accomplishes the following:</p>
          
          <ul>
          <li>Show two randomly selected fighters from different teams on the home page</li>
          <li>Record each click on a fighter as a "win" for that fighter</li>
          <li>Allow me to create, update, and delete arenas</li>
          <li>Allow me to create, update, and delete fighters, including their images which get uploaded to S3</li>
          </ul>
          
          <p>It uses <a href="https://github.com/weavejester/clj-aws-s3">"clj-aws-s3"</a> and
          <a href="http://clojuremongodb.info/">"Clojure Monger"</a>.</p>
          
          <p>All the code discussed here is
          <a href="https://github.com/flyingmachine/nanoc-blog/tree/master/content/assets/source/clojure/refactoring-to-datamappers">"available on github"</a>.</p>
          
          <h2>The Original Monster</h2>
          
          <p>Below is the most complex of my models:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.models.fighter</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.config</span> <span class="ss">:as</span> <span class="nv">config</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">monger.collection</span> <span class="ss">:as</span> <span class="nv">mc</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.lib.aws.s3</span> <span class="ss">:as</span> <span class="nv">s3</span><span class="p">])</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.bson.types</span> <span class="nv">ObjectId</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">org.imgscalr</span> <span class="nv">Scalr</span> <span class="nv">Scalr$Method</span> <span class="nv">Scalr$Mode</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">javax.imageio</span> <span class="nv">ImageIO</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">java.awt.image</span> <span class="nv">BufferedImageOp</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">java.awt.image</span> <span class="nv">BufferedImage</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">org.apache.commons.io</span> <span class="nv">FilenameUtils</span><span class="p">]))</span>&#x000A;&#x000A;<span class="c1">;; Used to generate the different sizes</span>&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">*image-versions</span> <span class="p">[[</span><span class="s">"card"</span> <span class="mi">192</span><span class="p">]</span>&#x000A;                      <span class="p">[</span><span class="s">"listing"</span> <span class="mi">64</span><span class="p">]</span>&#x000A;                      <span class="p">[</span><span class="s">"battle"</span> <span class="mi">432</span> <span class="mi">638</span><span class="p">]])</span>&#x000A;&#x000A;<span class="c1">;; For monger</span>&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">*collection</span> <span class="s">"fighters"</span><span class="p">)</span>&#x000A;&#x000A;<span class="c1">;; ----</span>&#x000A;<span class="c1">;; Image processing and storage</span>&#x000A;<span class="c1">;; ----</span>&#x000A;&#x000A;<span class="c1">;; The image-path functions are used both to store the image in S3 and</span>&#x000A;<span class="c1">;; to generate the URL for the image when viewed on the web</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-relative-path</span> <span class="p">[</span><span class="nv">version</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">_id</span> <span class="nv">image-extension</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"fighters/"</span> <span class="nv">_id</span> <span class="s">"/"</span> <span class="nv">version</span> <span class="s">"."</span> <span class="nv">image-extension</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-path</span> <span class="p">[</span><span class="nv">version</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"/"</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">version</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">bucket-name</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"arenaverse-"</span> <span class="p">(</span><span class="nb">name </span><span class="nv">config/env</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">amazon-image-path</span> <span class="p">[</span><span class="nv">version</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"https://s3.amazonaws.com/"</span> <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span> <span class="p">(</span><span class="nf">image-path</span> <span class="nv">version</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">image-fields</span> <span class="p">[</span><span class="nv">object-id</span> <span class="nv">image-extension</span><span class="p">]</span>&#x000A;  <span class="p">{</span><span class="ss">:_id</span> <span class="nv">object-id</span>&#x000A;   <span class="ss">:image-extension</span> <span class="p">(</span><span class="nf">clojure.string/replace</span> <span class="nv">image-extension</span> <span class="s">"jpeg"</span> <span class="s">"jpg"</span><span class="p">)})</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">save-image</span> <span class="p">[</span><span class="nb">path </span><span class="nv">file</span> <span class="nv">content-type</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">s3/put-object</span> <span class="nv">config/*aws-credentials*</span>&#x000A;                 <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span>&#x000A;                 <span class="nv">path</span>&#x000A;                 <span class="nv">file</span>&#x000A;                 <span class="p">{</span><span class="ss">:content-type</span> <span class="nv">content-type</span><span class="p">}</span>&#x000A;                 <span class="o">#</span><span class="p">(</span><span class="nf">.withCannedAcl</span> <span class="nv">%</span> <span class="nv">com.amazonaws.services.s3.model.CannedAccessControlList/PublicRead</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">resize</span>&#x000A;  <span class="p">([</span><span class="nv">image</span> <span class="nv">box</span><span class="p">]</span>&#x000A;     <span class="p">(</span><span class="nf">resize</span> <span class="nv">image</span> <span class="nv">box</span> <span class="nv">box</span><span class="p">))</span>&#x000A;  <span class="p">([</span><span class="nv">image</span> <span class="nv">target-width</span> <span class="nv">target-height</span><span class="p">]</span>&#x000A;     <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">width</span>  <span class="p">(</span><span class="nf">.getWidth</span> <span class="nv">image</span><span class="p">)</span>&#x000A;           <span class="nv">height</span> <span class="p">(</span><span class="nf">.getHeight</span> <span class="nv">image</span><span class="p">)</span>&#x000A;           <span class="nv">fit</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">/ </span><span class="nv">target-width</span> <span class="nv">width</span><span class="p">)</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">target-height</span> <span class="nv">height</span><span class="p">))</span> <span class="nv">Scalr$Mode/FIT_TO_HEIGHT</span> <span class="nv">Scalr$Mode/FIT_TO_WIDTH</span><span class="p">)]</span>&#x000A;       <span class="p">(</span><span class="nf">Scalr/resize</span> <span class="nv">image</span> <span class="nv">Scalr$Method/ULTRA_QUALITY</span> <span class="nv">fit</span> <span class="nv">target-width</span> <span class="nv">target-height</span> <span class="p">(</span><span class="nb">into-array </span><span class="nv">BufferedImageOp</span> <span class="p">[])))))</span>&#x000A;&#x000A;<span class="c1">;; This is necessary because the S3 java library works with input</span>&#x000A;<span class="c1">;; streams</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">buffered-image-&gt;input-stream</span> <span class="p">[</span><span class="nv">buffered-image</span> <span class="nv">extension</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">os</span> <span class="p">(</span><span class="nf">java.io.ByteArrayOutputStream.</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">ImageIO/write</span> <span class="nv">buffered-image</span> <span class="nv">extension</span> <span class="nv">os</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">java.io.ByteArrayInputStream.</span> <span class="p">(</span><span class="nf">.toByteArray</span> <span class="nv">os</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">resize-and-save-image</span> <span class="p">[</span><span class="nv">object-id</span> <span class="nv">file-upload</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="p">(</span><span class="ss">:size</span> <span class="nv">file-upload</span><span class="p">)))</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">extension</span>    <span class="p">(</span><span class="nf">FilenameUtils/getExtension</span> <span class="p">(</span><span class="ss">:filename</span> <span class="nv">file-upload</span><span class="p">))</span>&#x000A;          <span class="nv">content-type</span> <span class="p">(</span><span class="ss">:content-type</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;          <span class="nv">file</span>         <span class="p">(</span><span class="ss">:tempfile</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;          <span class="nv">img-fields</span>   <span class="p">(</span><span class="nf">image-fields</span> <span class="nv">object-id</span> <span class="nv">extension</span><span class="p">)]</span>&#x000A;      <span class="c1">;; save original</span>&#x000A;      <span class="p">(</span><span class="nf">save-image</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="s">"original"</span> <span class="nv">img-fields</span><span class="p">)</span> <span class="nv">file</span> <span class="nv">content-type</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">buff-img</span> <span class="p">(</span><span class="nf">ImageIO/read</span> <span class="nv">file</span><span class="p">)]</span>&#x000A;        <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">version</span> <span class="o">&amp;</span> <span class="nv">dim</span><span class="p">]</span> <span class="nv">*image-versions</span><span class="p">]</span>&#x000A;          <span class="p">(</span><span class="nf">save-image</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">version</span> <span class="nv">img-fields</span><span class="p">)</span>&#x000A;                      <span class="p">(</span><span class="nf">buffered-image-&gt;input-stream</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">resize</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">buff-img</span> <span class="nv">dim</span><span class="p">))</span> <span class="nv">extension</span><span class="p">)</span>&#x000A;                      <span class="nv">version</span><span class="p">))))))</span>&#x000A;&#x000A;<span class="c1">;;----</span>&#x000A;<span class="c1">;; CRUD-related</span>&#x000A;<span class="c1">;;---- </span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">delete-images</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">vname</span><span class="p">]</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">*image-versions</span> <span class="p">[</span><span class="s">"original"</span><span class="p">])]</span>&#x000A;    <span class="p">(</span><span class="nf">s3/delete-object</span> <span class="nv">config/*aws-credentials*</span> <span class="s">"arenaverse-test"</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">vname</span> <span class="nv">record</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">create</span> <span class="p">[</span><span class="nv">attrs</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span><span class="p">)</span>&#x000A;        <span class="nv">file-upload</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">attrs</span><span class="p">)</span>&#x000A;        <span class="nv">fields</span> <span class="p">(</span><span class="nf">merge</span>&#x000A;                <span class="p">(</span><span class="nb">dissoc </span><span class="nv">attrs</span> <span class="ss">:file</span><span class="p">)</span>&#x000A;                <span class="p">(</span><span class="nf">image-fields</span> <span class="nv">object-id</span> <span class="p">(</span><span class="nf">FilenameUtils/getExtension</span> <span class="p">(</span><span class="ss">:filename</span> <span class="nv">file-upload</span><span class="p">))))]</span>&#x000A;    <span class="p">(</span><span class="nf">mc/insert</span> <span class="nv">*collection</span> <span class="nv">fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">resize-and-save-image</span> <span class="nv">object-id</span> <span class="nv">file-upload</span><span class="p">))</span>&#x000A;    <span class="nv">fields</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-extension-for-update</span> <span class="p">[</span><span class="nv">attrs</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-upload</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">attrs</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not= </span><span class="mi">0</span> <span class="p">(</span><span class="ss">:size</span> <span class="nv">file-upload</span><span class="p">))</span>&#x000A;      <span class="p">(</span><span class="nf">image-fields</span> <span class="s">""</span> <span class="p">(</span><span class="nf">FilenameUtils/getExtension</span> <span class="p">(</span><span class="ss">:filename</span> <span class="nv">file-upload</span><span class="p">)))</span>&#x000A;      <span class="p">(</span><span class="nb">select-keys </span><span class="nv">record</span> <span class="p">[</span><span class="ss">:image-extension</span><span class="p">]))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">update</span> <span class="p">[</span><span class="nv">attrs</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">_id</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">attrs</span><span class="p">)</span>&#x000A;        <span class="nv">bson-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)</span>&#x000A;        <span class="nv">record</span> <span class="p">(</span><span class="nf">mc/find-map-by-id</span> <span class="nv">*collection</span> <span class="nv">bson-id</span><span class="p">)</span>&#x000A;        <span class="nv">updated-fields</span> <span class="p">(</span><span class="nb">dissoc </span><span class="p">(</span><span class="nb">merge </span><span class="nv">record</span>&#x000A;                                      <span class="nv">attrs</span>&#x000A;                                      <span class="p">(</span><span class="nf">image-extension-for-update</span> <span class="nv">attrs</span> <span class="nv">record</span><span class="p">))</span>&#x000A;                               <span class="ss">:_id</span>&#x000A;                               <span class="ss">:file</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">mc/update-by-id</span> <span class="nv">*collection</span> <span class="nv">bson-id</span> <span class="nv">updated-fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">resize-and-save-image</span> <span class="nv">_id</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">attrs</span><span class="p">)))</span>&#x000A;    <span class="nv">updated-fields</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">destroy</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">delete-images</span> <span class="p">(</span><span class="nf">mc/find-map-by-id</span> <span class="nv">*collection</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)))</span>&#x000A;  <span class="p">(</span><span class="nf">mc/remove-by-id</span> <span class="nv">*collection</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">one</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;  <span class="p">(</span><span class="nf">mc/find-one-as-map</span> <span class="nv">*collection</span> <span class="nv">query-doc</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">all</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;  <span class="p">(</span><span class="nf">mc/find-maps</span> <span class="nv">*collection</span> <span class="nv">query-doc</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">.toString</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">record</span><span class="p">)))</span></pre></div>
          <p>So, yeah, that's a ton of code. Breaking it into two groups,
          image-handling and CRUD operations, might help to quickly grok it.</p>
          
          <p>The main problem with the fighter model is that it has little explicit
          structure. There's no design. It's all just "keep doing stuff until
          you get the result you want." Sure, you have common functionality
          refactored into separate functions. For instance,
          <code>resize-and-save-image</code> is needed by both <code>create</code> and <code>update</code>, so it
          gets its own function.</p>
          
          <p>But that's not design. That's coding by
          convenience. <a href="http://www.flyingmachinestudios.com/design/anatomy-of-frustration/">"Well-designed"</a>
          code is predictable code. It follows a pattern, giving you a headstart
          when writing new code and allowing you to quickly assimilate
          unfamiliar parts of the system.</p>
          
          <p>To complete the picture, here's the arena model:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.models.arena</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.config</span> <span class="ss">:as</span> <span class="nv">config</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">monger.collection</span> <span class="ss">:as</span> <span class="nv">mc</span><span class="p">])</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.bson.types</span> <span class="nv">ObjectId</span><span class="p">]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">*collection</span> <span class="s">"arenas"</span><span class="p">)</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">destroy</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">mc/remove-by-id</span> <span class="nv">*collection</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">all</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">mc/find-maps</span> <span class="nv">*collection</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">one</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;  <span class="p">(</span><span class="nf">mc/find-one-as-map</span> <span class="nv">*collection</span> <span class="nv">query-doc</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">.toString</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">record</span><span class="p">)))</span></pre></div>
          <p>As you can see, the functions are essentially the same as those in the fighter model. Good ol' copy-and-paste coding. Clipboard-driven design. One of the cardinal sins of programming. Truly, I am ashamed.</p>
          
          <h2>Enter the Hero: Datamapper</h2>
          
          <p>(Wow, check out that heading! This is getting epic! As befits an
          article about a site as majestic and grand as OMG! SMACKDOWN!!!)</p>
          
          <p>I have something embarrasing to admit. I've already revealed my
          clipboard abuse, and nothing could be as bad that, so here goes: I
          don't really know what a Model is. Sure, it's the "M" in MVC, it's a
          staple of software design, it's something that's been in every Rails
          (and merb! yeah I was one of those guys for awhile) project, large and
          small, that I've been involved with since I first watched
          <a href="http://www.youtube.com/watch?v=Gzj723LkRJY">"DHH's Danish-accented, whoops-laden screencast"</a>.</p>
          
          <p>But in writing the above code, I felt like I was throwing everything
          into the <code>fighter</code> model out of habit. I kept asking myself, "what
          <em>is</em> a model, really?" I know, I know, I should stop with the soul
          searching and get back to the code. What I'm getting at, though, is
          that Clojure (and to some extent Noir) is really forcing me to
          re-examine my current habits and assumptions about coding and software
          design.</p>
          
          <p>Here are the decisions I introduced to impose order:</p>
          
          <h3>I'm dealing with "data mappers", not "models"</h3>
          
          <p>The code above concerns itself with:</p>
          
          <ul>
          <li>Transforming user input in order to persist it</li>
          <li>Persisting the transformed data</li>
          <li>Retrieving data from storage</li>
          <li>Transforming retrieved data for consumption by the system</li>
          </ul>
          
          <p>This data-centric view of the world speaks more of lightweight, "dumb"
          data structures than heavyweight, overly-smart "models". Perhaps the
          distinction is all in my head, but by using the term "data mapper" I
          want to communicate that the code's purpose is to act as a pipe - a
          "map", if you will - between the domain layer and the persistence
          layer.</p>
          
          <h3>Data mappers should clearly distinguish data, transformation, and persistence</h3>
          
          <p>In the original <code>fighter.clj</code>, I mix together transformation and
          persistence functions, as you can see below:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">defn- </span><span class="nv">resize-and-save-image</span> <span class="p">[</span><span class="nv">object-id</span> <span class="nv">file-upload</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="p">(</span><span class="ss">:size</span> <span class="nv">file-upload</span><span class="p">)))</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">extension</span>    <span class="p">(</span><span class="nf">FilenameUtils/getExtension</span> <span class="p">(</span><span class="ss">:filename</span> <span class="nv">file-upload</span><span class="p">))</span>&#x000A;          <span class="nv">content-type</span> <span class="p">(</span><span class="ss">:content-type</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;          <span class="nv">file</span>         <span class="p">(</span><span class="ss">:tempfile</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;          <span class="nv">img-fields</span>   <span class="p">(</span><span class="nf">image-fields</span> <span class="nv">object-id</span> <span class="nv">extension</span><span class="p">)]</span>&#x000A;      <span class="c1">;; save original</span>&#x000A;      <span class="p">(</span><span class="nf">save-image</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="s">"original"</span> <span class="nv">img-fields</span><span class="p">)</span> <span class="nv">file</span> <span class="nv">content-type</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">buff-img</span> <span class="p">(</span><span class="nf">ImageIO/read</span> <span class="nv">file</span><span class="p">)]</span>&#x000A;        <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">version</span> <span class="o">&amp;</span> <span class="nv">dim</span><span class="p">]</span> <span class="nv">*image-versions</span><span class="p">]</span>&#x000A;          <span class="p">(</span><span class="nf">save-image</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">version</span> <span class="nv">img-fields</span><span class="p">)</span>&#x000A;                      <span class="p">(</span><span class="nf">buffered-image-&gt;input-stream</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">resize</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">buff-img</span> <span class="nv">dim</span><span class="p">))</span> <span class="nv">extension</span><span class="p">)</span>&#x000A;                      <span class="nv">version</span><span class="p">))))))</span></pre></div>
          <p>I mean, the name is "resize-AND-save-image". Transform AND persist,
          mooshed together. This looks like exactly the kind of "complecting"
          that Rich Hickey talked about. I'm shoving two things together which
          really don't belong together.</p>
          
          <p>What I decided to instead was to be explicit about the persistence
          process. Functions should transform input data into a representation
          appropriate for the storage medium. Then a separate function should
          store that representation. This way, the persistence function has no
          knowledge of the transformation function and vice versa.</p>
          
          <p>The same applies to data retrieval. First, retrieve a representation
          from storage. Next, transform that data using a function. Return the
          new representation.</p>
          
          <p>One specific benefit I wanted to get out of this process was to remove
          any need for domain code to translate between string ID's and
          mongodb's BSON <code>ObjectIDs</code>. I had <code>(idstr fighter)</code> littered all
          throughout my views, and that was ugly and unnecessary.</p>
          
          <h2>The Refactored Code</h2>
          
          <p>Here's the refactored fighter.clj file:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.data-mappers.fighter</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.data-mappers.db</span> <span class="ss">:as</span> <span class="nv">db</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.lib.aws.s3</span> <span class="ss">:as</span> <span class="nv">s3</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">arenaverse.config</span> <span class="ss">:as</span> <span class="nv">config</span><span class="p">])</span>&#x000A;&#x000A;  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.bson.types</span> <span class="nv">ObjectId</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">org.imgscalr</span> <span class="nv">Scalr</span> <span class="nv">Scalr$Method</span> <span class="nv">Scalr$Mode</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">javax.imageio</span> <span class="nv">ImageIO</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">java.awt.image</span> <span class="nv">BufferedImageOp</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">java.awt.image</span> <span class="nv">BufferedImage</span><span class="p">]</span>&#x000A;           <span class="p">[</span><span class="nv">org.apache.commons.io</span> <span class="nv">FilenameUtils</span><span class="p">]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">declare </span><span class="nv">one-by-id</span><span class="p">)</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">db/add-db-reqs</span><span class="p">)</span>&#x000A;<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">collection-name</span> <span class="s">"fighters"</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-db-fns</span> <span class="nv">collection-name</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-finder-fns</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">*image-versions</span> <span class="p">[[</span><span class="s">"card"</span> <span class="mi">192</span><span class="p">]</span>&#x000A;                      <span class="p">[</span><span class="s">"listing"</span> <span class="mi">64</span><span class="p">]</span>&#x000A;                      <span class="p">[</span><span class="s">"battle"</span> <span class="mi">432</span> <span class="mi">638</span><span class="p">]])</span>&#x000A;&#x000A;<span class="c1">;;----</span>&#x000A;<span class="c1">;; Images</span>&#x000A;<span class="c1">;;----</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-relative-path</span> <span class="p">[</span><span class="nv">version</span> <span class="p">{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">_id</span> <span class="nv">image-extension</span><span class="p">]}]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"fighters/"</span> <span class="nv">_id</span> <span class="s">"/"</span> <span class="nv">version</span> <span class="s">"."</span> <span class="nv">image-extension</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">image-path</span> <span class="p">[</span><span class="nv">version</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"/"</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">version</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; TODO not hardcode this</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">bucket-name</span> <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"arenaverse-"</span> <span class="p">(</span><span class="nb">name </span><span class="nv">config/env</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">amazon-image-path</span> <span class="p">[</span><span class="nv">version</span> <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">str </span><span class="s">"https://s3.amazonaws.com/"</span> <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span> <span class="p">(</span><span class="nf">image-path</span> <span class="nv">version</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">normalize-image-extension</span> <span class="p">[</span><span class="nv">extension</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">clojure.string/replace</span> <span class="nv">extension</span> <span class="s">"jpeg"</span> <span class="s">"jpg"</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">image-fields</span> <span class="p">[</span><span class="nv">object-id</span> <span class="nv">image-extension</span><span class="p">]</span>&#x000A;  <span class="p">{</span><span class="ss">:_id</span> <span class="nv">object-id</span>&#x000A;   <span class="ss">:image-extension</span> <span class="p">(</span><span class="nf">normalize-image-extension</span> <span class="nv">image-extension</span><span class="p">)})</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">resize</span>&#x000A;  <span class="p">([</span><span class="nv">image</span> <span class="nv">box</span><span class="p">]</span>&#x000A;     <span class="p">(</span><span class="nf">resize</span> <span class="nv">image</span> <span class="nv">box</span> <span class="nv">box</span><span class="p">))</span>&#x000A;  <span class="p">([</span><span class="nv">image</span> <span class="nv">target-width</span> <span class="nv">target-height</span><span class="p">]</span>&#x000A;     <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">width</span>  <span class="p">(</span><span class="nf">.getWidth</span> <span class="nv">image</span><span class="p">)</span>&#x000A;           <span class="nv">height</span> <span class="p">(</span><span class="nf">.getHeight</span> <span class="nv">image</span><span class="p">)</span>&#x000A;           <span class="nv">fit</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">/ </span><span class="nv">target-width</span> <span class="nv">width</span><span class="p">)</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">target-height</span> <span class="nv">height</span><span class="p">))</span> <span class="nv">Scalr$Mode/FIT_TO_HEIGHT</span> <span class="nv">Scalr$Mode/FIT_TO_WIDTH</span><span class="p">)]</span>&#x000A;       <span class="p">(</span><span class="nf">Scalr/resize</span> <span class="nv">image</span> <span class="nv">Scalr$Method/ULTRA_QUALITY</span> <span class="nv">fit</span> <span class="nv">target-width</span> <span class="nv">target-height</span> <span class="p">(</span><span class="nb">into-array </span><span class="nv">BufferedImageOp</span> <span class="p">[])))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">buffered-image-&gt;input-stream</span> <span class="p">[</span><span class="nv">buffered-image</span> <span class="nv">extension</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">os</span> <span class="p">(</span><span class="nf">java.io.ByteArrayOutputStream.</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">ImageIO/write</span> <span class="nv">buffered-image</span> <span class="nv">extension</span> <span class="nv">os</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">java.io.ByteArrayInputStream.</span> <span class="p">(</span><span class="nf">.toByteArray</span> <span class="nv">os</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">input-&gt;image-extension</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">FilenameUtils/getExtension</span> <span class="p">(</span><span class="ss">:filename</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">image-uploaded?</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="p">(</span><span class="ss">:size</span> <span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">input-&gt;images</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">file-upload</span>   <span class="p">(</span><span class="ss">:file</span> <span class="nv">input</span><span class="p">)</span>&#x000A;        <span class="nv">original-file</span> <span class="p">(</span><span class="ss">:tempfile</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;        <span class="nv">content-type</span>  <span class="p">(</span><span class="ss">:content-type</span> <span class="nv">file-upload</span><span class="p">)</span>&#x000A;        <span class="nv">original-image</span> <span class="p">{</span><span class="ss">:version</span> <span class="s">"original"</span>&#x000A;                        <span class="ss">:file</span> <span class="nv">original-file</span>&#x000A;                        <span class="ss">:content-type</span> <span class="nv">content-type</span><span class="p">}</span>&#x000A;        <span class="nv">image-extension</span> <span class="p">(</span><span class="nf">normalize-image-extension</span> <span class="p">(</span><span class="nf">input-&gt;image-extension</span> <span class="nv">input</span><span class="p">))</span>&#x000A;        <span class="nv">buff-img</span> <span class="p">(</span><span class="nf">ImageIO/read</span> <span class="nv">original-file</span><span class="p">)]</span>&#x000A;&#x000A;    <span class="c1">;; TODO make this a lazy seq</span>&#x000A;    <span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">version</span> <span class="o">&amp;</span> <span class="nv">dim</span><span class="p">]]</span>&#x000A;                 <span class="p">{</span><span class="ss">:version</span> <span class="nv">version</span>&#x000A;                  <span class="ss">:file</span> <span class="p">(</span><span class="nf">buffered-image-&gt;input-stream</span>&#x000A;                         <span class="p">(</span><span class="nb">apply </span><span class="nv">resize</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">buff-img</span> <span class="nv">dim</span><span class="p">))</span>&#x000A;                         <span class="nv">image-extension</span><span class="p">)</span>&#x000A;                  <span class="ss">:content-type</span> <span class="nv">content-type</span><span class="p">})</span>&#x000A;               <span class="nv">*image-versions</span><span class="p">)</span>&#x000A;          <span class="nv">original-image</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">store-image</span> <span class="p">[</span><span class="nv">image</span>, <span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">s3/put-object</span> <span class="nv">config/*aws-credentials*</span>&#x000A;                 <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span>&#x000A;                 <span class="p">(</span><span class="nf">image-relative-path</span> <span class="p">(</span><span class="ss">:version</span> <span class="nv">image</span><span class="p">)</span> <span class="nv">record</span><span class="p">)</span>&#x000A;                 <span class="p">(</span><span class="ss">:file</span> <span class="nv">image</span><span class="p">)</span>&#x000A;                 <span class="p">{</span><span class="ss">:content-type</span> <span class="p">(</span><span class="ss">:content-type</span> <span class="nv">image</span><span class="p">)}</span>&#x000A;                 <span class="o">#</span><span class="p">(</span><span class="nf">.withCannedAcl</span> <span class="nv">%</span> <span class="nv">com.amazonaws.services.s3.model.CannedAccessControlList/PublicRead</span><span class="p">)))</span>&#x000A;&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">store-images</span> <span class="p">[</span><span class="nv">input</span> <span class="nv">db-fields</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">future</span>&#x000A;    <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="nv">image</span> <span class="p">(</span><span class="nf">input-&gt;images</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;      <span class="p">(</span><span class="nf">store-image</span> <span class="nv">image</span> <span class="nv">db-fields</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">create-input-&gt;db-fields</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">merge</span>&#x000A;     <span class="p">(</span><span class="nb">dissoc </span><span class="nv">input</span> <span class="ss">:file</span><span class="p">)</span>&#x000A;     <span class="p">(</span><span class="nf">image-fields</span> <span class="nv">object-id</span> <span class="p">(</span><span class="nf">input-&gt;image-extension</span> <span class="nv">input</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">update-input-&gt;db-fields</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">input</span><span class="p">))</span>&#x000A;        <span class="nv">record</span> <span class="p">(</span><span class="nf">db-one-by-id</span> <span class="nv">object-id</span><span class="p">)</span>&#x000A;        <span class="c1">;; ensure that the user doesn't alter the arena id</span>&#x000A;        <span class="c1">;; and that image-extension isn't overwritten when no file is present</span>&#x000A;        <span class="nv">db-fields</span> <span class="p">(</span><span class="nf">merge</span>&#x000A;                   <span class="p">(</span><span class="nb">select-keys </span><span class="nv">record</span> <span class="p">[</span><span class="ss">:image-extension</span><span class="p">])</span>&#x000A;                   <span class="p">(</span><span class="nb">dissoc </span><span class="nv">input</span> <span class="ss">:_id</span> <span class="ss">:file</span><span class="p">)</span>&#x000A;                   <span class="p">(</span><span class="nb">select-keys </span><span class="nv">record</span> <span class="p">[</span><span class="ss">:arena-id</span><span class="p">]))]</span>&#x000A;    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span>&#x000A;      <span class="p">(</span><span class="nb">merge </span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">image-fields</span> <span class="nv">object-id</span> <span class="p">(</span><span class="nf">input-&gt;image-extension</span> <span class="nv">input</span><span class="p">)))</span>&#x000A;      <span class="nv">db-fields</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">create</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">create-input-&gt;db-fields</span> <span class="nv">input</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">db-insert</span> <span class="nv">db-fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span> <span class="p">(</span><span class="nf">store-images</span> <span class="nv">input</span> <span class="nv">db-fields</span><span class="p">))</span>&#x000A;    <span class="nv">db-fields</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; this is weird... i remove the object id in the -&gt;db-fields method,</span>&#x000A;<span class="c1">;; then add it back again</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">update</span> <span class="p">[</span><span class="nv">input</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">db-fields</span> <span class="p">(</span><span class="nf">update-input-&gt;db-fields</span> <span class="nv">input</span><span class="p">)</span>&#x000A;        <span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">input</span><span class="p">))</span>&#x000A;        <span class="nv">record</span>    <span class="p">(</span><span class="nb">merge </span><span class="nv">db-fields</span> <span class="p">{</span><span class="ss">:_id</span> <span class="nv">object-id</span><span class="p">})]</span>&#x000A;    <span class="p">(</span><span class="nf">db-update-by-id</span> <span class="nv">object-id</span> <span class="nv">db-fields</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nf">image-uploaded?</span> <span class="nv">input</span><span class="p">)</span> <span class="p">(</span><span class="nf">store-images</span> <span class="nv">input</span> <span class="nv">db-fields</span><span class="p">))</span>&#x000A;    <span class="nv">db-fields</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; TODO query S3 first to avoid missing any images if i.e. image</span>&#x000A;<span class="c1">;; version names change</span>&#x000A;<span class="p">(</span><span class="kd">defn- </span><span class="nv">delete-images</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">vname</span><span class="p">]</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">*image-versions</span> <span class="p">[</span><span class="s">"original"</span><span class="p">])]</span>&#x000A;    <span class="p">(</span><span class="nf">s3/delete-object</span> <span class="nv">config/*aws-credentials*</span> <span class="p">(</span><span class="nf">bucket-name</span><span class="p">)</span> <span class="p">(</span><span class="nf">image-relative-path</span> <span class="nv">vname</span> <span class="nv">record</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">destroy</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">object-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)</span>&#x000A;        <span class="nv">record</span> <span class="p">(</span><span class="nf">db-one-by-id</span> <span class="nv">object-id</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">delete-images</span> <span class="nv">record</span><span class="p">)</span>&#x000A;    <span class="p">(</span><span class="nf">db-destroy</span> <span class="nv">object-id</span><span class="p">)))</span></pre></div>
          <p><code>resize-and-save-image</code> has been broken into <code>input-&gt;images</code> and
          <code>store-image</code>, lines 67 and 87, and neither has knowledge of the
          other. I also introduced <code>create-input-&gt;db-fields</code> and
          <code>update-input-&gt;db-fields</code>.</p>
          
          <p>You might also have noticed some weird code at lines 15-18. The
          functions being used are here:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.data-mappers.db</span><span class="p">)</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">add-db-reqs</span> <span class="p">[]</span>&#x000A;  <span class="o">'</span><span class="p">(</span><span class="nf">do</span>&#x000A;     <span class="p">(</span><span class="nf">require</span> <span class="ss">'monger.collection</span><span class="p">)</span>&#x000A;     <span class="p">(</span><span class="nb">import </span><span class="ss">'org.bson.types.ObjectId</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; TODO ~' Insanity! #cthulhu</span>&#x000A;<span class="c1">;; These macros are meant to infect the namespace with functions. Why</span>&#x000A;<span class="c1">;; would I want to do this? Should I take heed of the fact that</span>&#x000A;<span class="c1">;; Clojure really doesn't want me to?</span>&#x000A;&#x000A;<span class="c1">;; I wrote these fucntions to avoid having to write collection-name</span>&#x000A;<span class="c1">;; all over the place</span>&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">add-db-fns</span> <span class="p">[</span><span class="nv">collection-name</span><span class="p">]</span>&#x000A;  <span class="o">`</span><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">collection-name#</span> <span class="o">~</span><span class="nv">collection-name</span><span class="p">]</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-destroy</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/remove-by-id</span> <span class="nv">collection-name#</span><span class="p">))</span>     &#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-one</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/find-one-as-map</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-one-by-id</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/find-map-by-id</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-all</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/find-maps</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-insert</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/insert</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-update-by-id</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/update-by-id</span> <span class="nv">collection-name#</span><span class="p">))</span>&#x000A;    <span class="p">(</span><span class="k">def </span><span class="o">~</span><span class="ss">'db-update</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">monger.collection/update</span> <span class="nv">collection-name#</span><span class="p">))))</span>&#x000A;&#x000A;<span class="c1">;; These methods are meant to generate the representations which</span>&#x000A;<span class="c1">;; non-db parts of the code will use. They all convert ObjectId's to</span>&#x000A;<span class="c1">;; strings because no other part of the system should care about ObjectId's</span>&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">add-finder-fns</span> <span class="p">[]</span>&#x000A;  <span class="o">'</span><span class="p">(</span><span class="nf">do</span>&#x000A;     <span class="c1">;; TODO this doesn't feel like it belongs here. It's a helper</span>&#x000A;     <span class="c1">;; method. But this macro approach is infecting everything!</span>&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nf">.toString</span> <span class="p">(</span><span class="ss">:_id</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">object-id-&gt;idstr</span> <span class="p">[</span><span class="nv">record</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nb">assoc </span><span class="nv">record</span> <span class="ss">:_id</span> <span class="p">(</span><span class="nf">idstr</span> <span class="nv">record</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="c1">;; TODO I don't like mapping in the all fn, feels wasteful.</span>&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">all</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;       <span class="p">(</span><span class="nb">map </span><span class="nv">object-id-&gt;idstr</span> <span class="p">(</span><span class="nf">db-all</span> <span class="nv">query-doc</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">one</span> <span class="p">[</span><span class="o">&amp;</span> <span class="p">[</span><span class="nv">query-doc</span><span class="p">]]</span>&#x000A;       <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">r</span> <span class="p">(</span><span class="nf">db-one</span> <span class="nv">query-doc</span><span class="p">)]</span>&#x000A;         <span class="p">(</span><span class="nf">object-id-&gt;idstr</span> <span class="nv">r</span><span class="p">)))</span>&#x000A;&#x000A;     <span class="p">(</span><span class="kd">defn </span><span class="nv">one-by-id</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;       <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">r</span> <span class="p">(</span><span class="nf">db-one-by-id</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">))]</span>&#x000A;         <span class="p">(</span><span class="nf">object-id-&gt;idstr</span> <span class="nv">r</span><span class="p">)))))</span></pre></div>
          <p>Now this is some seriously weird code. I don't know if this is a good
          idea at all - it doesn't feel like good Clojure or good lisp.</p>
          
          <p>That being said, there are two macros, both of which create new
          functions in the namespace in which they're called. The first set
          simply wraps monger functions and keeps me from having to repeat the
          mongodb collection name argument over and over. The second set of
          functions performs the storage-to-domain-representation
          transformations.</p>
          
          <p>You can see in the comments that I feel seriously weirded out by this
          code. It had me questioning what I'm really using namespaces for. If
          <code>idstr</code> does the exact same thing in every namespace that it's copied
          to, then why am I throwing it into multiple namespaces? <code>add-db-fns</code>
          helps me reduce duplication, but is it really worth it? Perhaps
          that'll be the subject of another blog post about another refactoring.</p>
          
          <p>For completeness's sake, here's the refactored arena.clj:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">arenaverse.data-mappers.arena</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">arenaverse.data-mappers.db</span> <span class="ss">:as</span> <span class="nv">db</span><span class="p">]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">db/add-db-reqs</span><span class="p">)</span>&#x000A;<span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">collection-name</span> <span class="s">"arenas"</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-db-fns</span> <span class="nv">collection-name</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">db/add-finder-fns</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">destroy</span> <span class="p">[</span><span class="nv">_id</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">db-destroy</span> <span class="p">(</span><span class="nf">ObjectId.</span> <span class="nv">_id</span><span class="p">)))</span></pre></div>
          <h2>A Scarier Monster?</h2>
          
          <p>Some more doubts about the new code:</p>
          
          <ul>
          <li>Should the image processing code be somewhere else?</li>
          <li>Should I write a wrapper around the S3 code, as I did for the monger code? Should I be more explicit about the representation/persistence relationship?</li>
          <li>How about the <code>amazon-image-path</code> function? Where does that go? In this case, I actually am doing something beyond just mapping data.</li>
          </ul>
          
          <h2>The End</h2>
          
          <p>Thus ends our exhausting - I mean, exhaustive - tour of this little refactoring. I'd love any feedback on the code!</p>
          
          <p>Special thanks to <a href="http://danielchoi.com/software/">"Daniel Choi"</a> for
          linking to the Rich Hickey talk and to
          <a href="http://bostonrb.org/">"bostonrb"</a> for a great discussion on
          simplicity.</p>
          <p>
            <a class='twitter-share-button' data-via='nonrecursive' href='https://twitter.com/share'>Tweet</a>
          </p>
          <script>
            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs')
          </script>
          <h2>Comments</h2>
          <div id='disqus_thread'></div>
          <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'flyingmachinestudios'; // required: replace example with your forum shortname
            
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
        </div>
      </div>
      <div id='nav'>
        <div class='articles'>
          <h2>Popular Blog Posts</h2>
          <ol>
            <li>
              <a class='title' href='/programming/the-unofficial-guide-to-rich-hickeys-brain/'>The Unofficial Guide to Rich Hickey's Brain</a>
            </li>
            <li>
              <a class='title' href='/programming/datomic-for-five-year-olds/'>Datomic for Five-Year-Olds</a>
            </li>
            <li>
              <a class='title' href='/programming/how-clojure-babies-are-made-lein-run/'>How Clojure Babies Are Made: Understanding lein run</a>
            </li>
          </ol>
          <h2>Recent Blog Posts</h2>
          <ol>
            <li>
              <a class='title' href='/programming/why-programmers-need-frameworks/'>Frameworks and Why (Clojure) Programmers Need Them</a>
            </li>
            <li>
              <a class='title' href='/people/buddy-system/'>Buddy Systems at Work: a Framework for Rewarding Relationships on Remote Teams</a>
            </li>
            <li>
              <a class='title' href='/programming/learn-programming-languages-efficiently/'>Techniques for Efficiently Learning Programming Languages</a>
            </li>
            <li>
              <a class='title' href='/essays/zen-joker/'>Zen and the Art of Blowing Things Up</a>
            </li>
            <li>
              <a class='title' href='/essays/process/'>My Writing Process</a>
            </li>
            <li>
              <a class='title' href='/programming/recursion/'>Understanding Recursion</a>
            </li>
            <li>
              <a class='title' href='/programming/timeless-tools/'>Timeless Programming Tools</a>
            </li>
          </ol>
        </div>
        <div class='projects'>
          <h2>Projects</h2>
          <ol>
            <li id='cftbat'>
              <header>
                <a href='http://braveclojure.com'>
                  Clojure for the Brave and True
                </a>
                <p>A goofy book for learning Clojure. No functional programming or Java experience required!</p>
              </header>
            </li>
            <li id='cuym'>
              <header>
                <a href='http://www.visualmess.com'>
                  Clean Up Your Mess: a Guide to Visual Design for Everyone
                </a>
              </header>
              <p>
                This popular guide will help you
                communicate with conscious skill. It will show you
                how to create designs that are easy to understand
                and attractive.
              </p>
            </li>
            <li id='gratefulplace'>
              <header>
                <a href='http://gratefulplace.com'>
                  Grateful Place
                </a>
              </header>
              <p>When we appreciate the good in our lives, the good grows and we have more of it.</p>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-666015-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
