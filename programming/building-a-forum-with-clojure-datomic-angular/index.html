<!DOCTYPE html>
<html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    </meta>
    <title>Building a Forum with Clojure, Datomic, Angular, and Ansible</title>
    <link href='/stylesheets/main.css?4' media='screen' rel='stylesheet' type='text/css'>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Ruthie|Gentium+Book+Basic:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='/stylesheets/pygments.css?3' media='screen' rel='stylesheet' type='text/css'>
    <link href='http://feeds.feedburner.com/FlyingMachineStudios' rel='alternate' type='application/rss+xml'>
  </head>
  <body>
    <header class='top'>
      <div class='display'>
        <div class='title'>
          <a href='/'>Flying Machine Studios</a>
        </div>
        <div class='subtitle'>
          adventures in making stuff with Daniel Higginbotham
        </div>
      </div>
    </header>
    <div id='document'>
      <div id='contact'>
        <ul>
          <li>
            <a href='http://twitter.com/nonrecursive'>
              <i class='fa fa-twitter'></i>
            </a>
          </li>
          <li>
            <a href='http://www.linkedin.com/in/danielhigginbotham'>
              <i class='fa fa-linkedin'></i>
            </a>
          </li>
          <li>
            <a href='https://github.com/flyingmachine'>
              <i class='fa fa-github'></i>
            </a>
          </li>
          <li>
            <a href='http://feeds.feedburner.com/FlyingMachineStudios'>
              <i class='fa fa-rss'></i>
            </a>
          </li>
        </ul>
      </div>
      <div id='main'>
        <div class='page' id='content'>
          <h1>Building a Forum with Clojure, Datomic, Angular, and Ansible</h1>
          <div class='date'>27 July 2013</div>
          <p>After many long months I've finished re-writing
          <a href="http://gratefulplace.com">Grateful Place</a>. The site now uses Clojure
          as an API server, with Datomic for the database, Angular for the front
          end, and Vagrant and Ansible for provisioning and deployment. This
          setup is awesome, the best of every world, and I love it.</p>
          
          <p>Below we'll dive into the code base, covering the most important parts
          of each component and how everything works together. We'll cover:</p>
          
          <ul>
          <li>Clojure API Server
          
          <ul>
          <li>Liberator for Easy API'ing</li>
          <li>Going on a Spirit Journey with Friend</li>
          <li>Testing a Clojure Web App is More Fun than Testing Rails</li>
          <li>Serving files generated by Grunt/Angular</li>
          <li>The Uberjar</li>
          </ul>
          </li>
          <li>Datomic
          
          <ul>
          <li>Why Oh Why Did I Do This</li>
          <li>The Poopy Code I Wrote to Make Basic Things "Easier"</li>
          <li>The Good Code I Ripped Off to do Migrations</li>
          <li>Mapification with Cartographer, My Very Own Clojure Library!!!</li>
          </ul>
          </li>
          <li>Angular
          
          <ul>
          <li>Peeking and Secondary Controllers</li>
          <li>Directives to the Rescue</li>
          </ul>
          </li>
          <li>Infrastructure
          
          <ul>
          <li>Creating a Local Sandbox with Vagrant</li>
          <li>Provisioning with Ansible</li>
          <li>Building and Deploying with a Janky Bash Script and Ansible</li>
          </ul>
          </li>
          <li>Development Workflow
          
          <ul>
          <li>Emacs Bookmarks and Keybindings</li>
          <li>tmuxinator Config</li>
          <li>Actually doing development</li>
          </ul>
          </li>
          </ul>
          
          <p>All source is available
          <a href="https://github.com/flyingmachine/gratefulplace2/tree/v1.0.0">on github</a>.
          This article isn't meant to be a tutorial. However, if you have any
          questions about how things work or about how to work on the codebase,
          please leave a comment and I'll do my best to clarify.</p>
          
          <h2>About the Site</h2>
          
          <p><a href="http://gratefulplace.com">Grateful Place</a> is my attempt at creating
          the kind of online community that I'd like to belong to. It's still in
          its infancy, but I'd like for it to become a site where people
          consciously help lift each other up. One way to do this is by
          expressing gratitude on a daily basis, which science says increases
          happiness.</p>
          
          <p>Some of the features include watching forum threads, liking posts, and
          creating a basic profile. I have a lot more planned, like tags and
          "summary" views, and I think the combination of Clojure and Angular
          will make it fun and easy for me to continue development :)</p>
          
          <p>If you want to have a look without diving head-first into hippified
          waters (what, do you have something against happiness?), you can
          <a href="http://fmslab.com">use the demo site</a> with username/password
          test101/test101. Be warned, though, that that server might have some
          bugs.</p>
          
          <p>Now, on to the code!</p>
          
          <h2>Clojure API Server</h2>
          
          <p>I'm very happy with using Clojure as an API server. The libraries
          involved are lightweight and transparent, with no magic, and that
          makes it so easy to fully understand what's going on. That was my
          experience with Liberator:</p>
          
          <h3>Liberator for Easy API'ing</h3>
          
          <p>Liberator provided me with a much better abstraction for handling
          logic which I was repeating in all of my controllers. For example, my
          <code>create</code> functions all basically looked like this before I moved to
          Liberator:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">defn </span><span class="nv">create!</span>&#x000A;  <span class="p">[</span><span class="nv">params</span> <span class="nv">auth</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">protect</span>&#x000A;   <span class="p">(</span><span class="ss">:id</span> <span class="nv">auth</span><span class="p">)</span>&#x000A;   <span class="p">(</span><span class="nf">if-valid</span>&#x000A;    <span class="nv">params</span> <span class="p">(</span><span class="ss">:create</span> <span class="nv">validations/post</span><span class="p">)</span> <span class="nv">errors</span>&#x000A;    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">post-map</span> <span class="p">(</span><span class="nf">create-post</span> <span class="nv">params</span><span class="p">)]</span>&#x000A;      <span class="p">{</span><span class="ss">:body</span> <span class="nv">post-map</span><span class="p">})</span>&#x000A;    <span class="p">(</span><span class="nf">invalid</span> <span class="nv">errors</span><span class="p">))))</span></pre></div>
          <p>The above code implements a decision tree:</p>
          
          <ol>
          <li>First, the <code>protect</code> macro is used to ensure you're authorized to
          do whatever you're trying to do. The first argument is a boolean
          expression, in this case <code>(:id auth)</code>, which just checks whether
          you're logged in. If the boolean expression is true, run everything
          that follows. Otherwise return an error status and error messages
          (<a href="https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/models/permissions.clj#L45">see implementation</a>).</li>
          <li>Check whether <code>params</code> is valid using the specified validation, in
          this case <code>(:create validations/post)</code>. If it's valid, run the <code>let</code>
          statement, otherwise make the validation errors available in <code>errors</code>
          and run <code>(invalid errors)</code>.</li>
          </ol>
          
          <p>There are a couple things that I didn't like about this approach. First,
          there was too much distance between the logical branches. For example,
          <code>protect</code> is basically an if statement, but the <code>else</code> is hidden.
          Also, the
          <a href="https://github.com/flyingmachine/gratefulplace2/blob/fefbebf463b00328e0bd5660ca5ea33899d7cd39/server/src/gratefulplace/controllers/posts.clj#L33">actual code</a>
          I wrote in <code>if-valid</code> is a bit long, which makes it difficult to
          visually understand how <code>(invalid errors)</code> relates.</p>
          
          <p>Second, this approach required me to introduce more nesting in order
          to add more steps or checks in the workflow. This would make it even
          harder to understand as I'd mentally have to descend and ascend a
          few conditionals in order to understand what's going on. I'd end up
          with something like:</p>
          <div class="highlight"><pre><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">one</span>&#x000A;<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">one</span><span class="w"> </span><span class="vg">first</span><span class="w"> </span><span class="nl">branch:</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">two</span>&#x000A;<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">two</span><span class="w"> </span><span class="vg">first</span><span class="w"> </span><span class="nl">branch:</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">three</span>&#x000A;<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">three</span><span class="w"> </span><span class="vg">first</span><span class="w"> </span><span class="vg">branch</span>&#x000A;<span class="w">        </span><span class="o">...</span>&#x000A;<span class="w">        </span><span class="vg">Lots</span><span class="w"> </span><span class="vg">of</span><span class="w"> </span><span class="vg">code</span><span class="w"> </span><span class="vg">here</span><span class="w"> </span><span class="vg">physically</span><span class="w"> </span><span class="vg">creating</span><span class="w"> </span><span class="vg">distance</span><span class="w"> </span><span class="vg">between</span>&#x000A;<span class="w">        </span><span class="vg">branches</span>&#x000A;<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">three</span><span class="w"> </span><span class="vg">second</span><span class="w"> </span><span class="vg">branch</span>&#x000A;<span class="w">        </span><span class="o">...</span>&#x000A;<span class="w">        </span><span class="vg">More</span><span class="w"> </span><span class="vg">code</span><span class="w"> </span><span class="vg">causing</span><span class="w"> </span><span class="vg">more</span><span class="w"> </span><span class="vg">distance</span>&#x000A;<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">two</span><span class="w"> </span><span class="vg">second</span><span class="w"> </span><span class="vg">branch</span>&#x000A;<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="vg">Decision</span><span class="w"> </span><span class="vg">one</span><span class="w"> </span><span class="vg">second</span><span class="w"> </span><span class="vg">branch</span><span class="o">...</span><span class="w"> </span><span class="vg">what</span><span class="w"> </span><span class="vg">was</span><span class="w"> </span><span class="vg">the</span><span class="w"> </span><span class="vg">decision</span><span class="w"> </span><span class="vg">even</span><span class="o">?</span>&#x000A;<span class="w">    </span><span class="vg">I</span><span class="w"> </span><span class="vg">can</span><span class="c1">'t remember and now it's hard for me to visually</span>&#x000A;<span class="w">    </span><span class="vg">associate</span><span class="w"> </span><span class="vg">this</span><span class="w"> </span><span class="vg">branch</span><span class="w"> </span><span class="vg">with</span><span class="w"> </span><span class="vg">its</span><span class="w"> </span><span class="vg">parent</span><span class="w"> </span><span class="vg">decision</span></pre></div>
          <p>So essentially, I'd have to keep an ever-growing decision tree in my
          head. The physical representation of the tree, the code, would help to
          obscure the logic flow as I added more code.</p>
          
          <p>Here's how the same function looks when rewritten using Liberator:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nf">defresource</span> <span class="nv">create!</span> <span class="p">[</span><span class="nv">params</span> <span class="nv">auth</span><span class="p">]</span>&#x000A;  <span class="ss">:allowed-methods</span> <span class="p">[</span><span class="ss">:post</span><span class="p">]</span>&#x000A;  <span class="ss">:available-media-types</span> <span class="p">[</span><span class="s">"application/json"</span><span class="p">]</span>&#x000A;  <span class="ss">:authorized?</span> <span class="p">(</span><span class="nf">logged-in?</span> <span class="nv">auth</span><span class="p">)</span>&#x000A;&#x000A;  <span class="ss">:malformed?</span> <span class="p">(</span><span class="nf">validator</span> <span class="nv">params</span> <span class="p">(</span><span class="ss">:create</span> <span class="nv">validations/post</span><span class="p">))</span>&#x000A;  <span class="ss">:handle-malformed</span> <span class="nv">errors-in-ctx</span>&#x000A;&#x000A;  <span class="ss">:post!</span> <span class="p">(</span><span class="nf">create-content</span> <span class="nv">ts/create-post</span> <span class="nv">params</span> <span class="nv">auth</span> <span class="nv">record</span><span class="p">)</span>&#x000A;  <span class="ss">:handle-created</span> <span class="nv">record-in-ctx</span><span class="p">)</span></pre></div>
          <p>Holy shnikes! That's so much clearer!</p>
          
          <p>Liberator improved my code by providing a
          <a href="http://clojure-liberator.github.io/liberator/doc/decisions.html">pre-defined, HTTP-compliant decision tree</a>,
          providing sensible default logic for nodes, and by allowing me to
          easily associate my own logic with the nodes. </p>
          
          <p>This allows me to concentrate on one node at a time, instead of having
          to keep an increasingly complicated tree structure in my head. For
          example, I can physically place the logic for <code>malformed?</code> next to the
          code that I want to run if the request <em>is</em> malformed, specified by
          <code>handle-malformed</code>.</p>
          
          <p>Liberator has excellent documentation and using it is a big win. It
          lets me just plug my own bits of logic into a carefully-coded, useful
          HTTP framework. I definitely recommend it.</p>
          
          <h3>Going on a Spirit Journey with Friend</h3>
          
          <p><a href="https://github.com/cemerick/friend">Friend</a> still kinda makes my head
          hurt. It's a useful library that gets the job done, but I feel like
          using it requires poring over the source code until you attain that
          brief flash of enlightenment that allows you to pound out the code you
          need for as long as some dark, atavistic, pre-conscious part of your
          brain can hold everything together. After that you pray that you won't
          need to change anything because, Jesus, that trip can take a lot out
          of you. I don't know, maybe that's why peyote was invented.</p>
          
          <p>Anyway, that's a testament to my own need to learn (and perhaps a need
          for slightly clearer documentation) and not to the quality or value of
          the library itself. Everything hangs together, working with Ring in a
          stateless way, which I really appreciate.</p>
          
          <p>OK enough of my blathering. We want code! The actual tricky bits were:</p>
          
          <ul>
          <li>Getting Friend to return errors instead of redirecting</li>
          <li>Creating an authenticated session as soon as a user registers
          instead of requiring login</li>
          </ul>
          
          <p>It turned out that the first wasn't all that difficult. I think.
          Here's the code
          <a href="https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/middleware/auth.clj#L25">on github</a>.
          It's also listed below, in the next code block.</p>
          
          <p>The key bit is <code>:login-failure-handler</code>, which simple returns a map
          for Ring. I also have <code>:redirect-on-auth?</code> listed twice. I'm not sure
          if this is necessary but every once in awhile I like to do some shaman
          programming, throwing chicken bones and listening to the wind in hopes
          that everything turns out OK. Things are working and I'm not going to
          mess with them.</p>
          
          <p>Creating the authenticated session is a different story. There are a
          lot of things going on. In order, they are:</p>
          
          <ol>
          <li>User submits registration form</li>
          <li>Request goes through a bunch of Ring middlewares that wrap the
          request, adding keyword params and handling json and whatnot</li>
          <li>Request hits the middleware created by Friend</li>
          <li>The request "hits" the <code>users/attempt-registration</code> Friend workflow</li>
          <li>If the registration is valid, return a friend authentication map.
          Friend "knows" that this is not meant to be a response sent to the
          browser, so the authentication map gets added to the Ring request map
          and the resulting map gets sent to the next Ring middleware</li>
          <li>The next ring middleware is <code>routes</code>
          </li>
          <li>The <code>users/registration-success-response</code> route matches</li>
          <li>
          <code>users/registration-success-response</code> returns a Ring map, providing
          a <code>body</code>. The response is a map like <code>{:id 1234 :username&#x000A;"flyingmachine"}</code>. This then gets used by Angular.</li>
          </ol>
          
          <p>Here's all the relevant code. Steps are indicated in brackets, like
          [1] or [2] or [3]. Step 1 is omitted as that's not code, you silly
          goose.</p>
          <div class="highlight"><pre><span class="c1">;; The ring app, https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/server.clj#L29</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">wrap</span>&#x000A;  <span class="p">[</span><span class="nv">to-wrap</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">to-wrap</span>&#x000A;      <span class="p">(</span><span class="nf">wrap-session</span> <span class="p">{</span><span class="ss">:cookie-name</span> <span class="s">"gratefulplace-session"</span> <span class="ss">:store</span> <span class="p">(</span><span class="nf">db-session-store</span> <span class="p">{})})</span>&#x000A;      <span class="p">(</span><span class="nf">wrap-restful-format</span> <span class="ss">:formats</span> <span class="p">[</span><span class="ss">:json-kw</span><span class="p">])</span>&#x000A;      <span class="nv">wrap-exception</span>&#x000A;      <span class="nv">wrap-keyword-params</span>&#x000A;      <span class="nv">wrap-nested-params</span>&#x000A;      <span class="nv">wrap-params</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">; The ring app</span>&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">app</span>&#x000A;  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">routes</span> <span class="c1">;; [6] after a successful registration the routes</span>&#x000A;             <span class="c1">;; middleware is called</span>&#x000A;      <span class="nv">auth</span> <span class="c1">;; [3] after request is wrapped, send it to friend</span>&#x000A;      <span class="nv">wrap</span> <span class="c1">;; [2]</span>&#x000A;      <span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; Friend middlware</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">auth</span>&#x000A;  <span class="p">[</span><span class="nv">ring-app</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">friend/authenticate</span>&#x000A;   <span class="nv">ring-app</span>&#x000A;   <span class="p">{</span><span class="ss">:credential-fn</span> <span class="p">(</span><span class="nb">partial </span><span class="nv">creds/bcrypt-credential-fn</span> <span class="nv">credential-fn</span><span class="p">)</span>&#x000A;    <span class="ss">:workflows</span> <span class="p">[(</span><span class="nf">workflows/interactive-form</span>&#x000A;                 <span class="ss">:redirect-on-auth?</span> <span class="nv">false</span>&#x000A;                 <span class="ss">:login-failure-handler</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">req</span><span class="p">]</span> <span class="p">{</span><span class="ss">:body</span> <span class="p">{</span><span class="ss">:errors</span> <span class="p">{</span><span class="ss">:username</span> <span class="p">[</span><span class="s">"invalid username or password"</span><span class="p">]}}</span> <span class="ss">:status</span> <span class="mi">401</span><span class="p">}))</span>&#x000A;                <span class="nv">users/attempt-registration</span> <span class="c1">;; [4]</span>&#x000A;                <span class="nv">session-store-authorize</span><span class="p">]</span>&#x000A;    <span class="ss">:redirect-on-auth?</span> <span class="nv">false</span>&#x000A;    <span class="ss">:login-uri</span> <span class="s">"/login"</span>&#x000A;    <span class="ss">:unauthorized-redirect-uri</span> <span class="s">"/login"</span><span class="p">}))</span>&#x000A;&#x000A;<span class="c1">;; [4] Friend runs this workflow function. If the workflow function</span>&#x000A;<span class="c1">;; returns falsey, then friend tries the next workflow function. In</span>&#x000A;<span class="c1">;; this case, when a user submits a registration form then the `when`</span>&#x000A;<span class="c1">;; boolean expression is true and the function will not return falsey.</span>&#x000A;<span class="c1">;; If the registration is successful it will return an authentication</span>&#x000A;<span class="c1">;; map and continue to step 5. If the registration is unsuccessful it</span>&#x000A;<span class="c1">;; will return a Ring response map, which is basically a map that has</span>&#x000A;<span class="c1">;; the keys :body or :status.</span>&#x000A;<span class="c1">;; https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/controllers/users.clj#L20</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">attempt-registration</span>&#x000A;  <span class="p">[</span><span class="nv">req</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[{</span><span class="ss">:keys</span> <span class="p">[</span><span class="nv">uri</span> <span class="nv">request-method</span> <span class="nv">params</span> <span class="nv">session</span><span class="p">]}</span> <span class="nv">req</span><span class="p">]</span>&#x000A;    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">= </span><span class="nv">uri</span> <span class="s">"/users"</span><span class="p">)</span>&#x000A;               <span class="p">(</span><span class="nb">= </span><span class="nv">request-method</span> <span class="ss">:post</span><span class="p">))</span>&#x000A;      <span class="p">(</span><span class="nf">if-valid</span>&#x000A;       <span class="nv">params</span> <span class="p">(</span><span class="ss">:create</span> <span class="nv">validations/user</span><span class="p">)</span> <span class="nv">errors</span>&#x000A;       <span class="c1">;; [5] Here's where we return the authentication map, which</span>&#x000A;       <span class="c1">;; Friend appends to the request map, sending the result to the</span>&#x000A;       <span class="c1">;; next middleware</span>&#x000A;       <span class="p">(</span><span class="nf">cemerick.friend.workflows/make-auth</span>&#x000A;        <span class="p">(</span><span class="nf">mapify-tx-result</span> <span class="p">(</span><span class="nf">ts/create-user</span> <span class="nv">params</span><span class="p">)</span> <span class="nv">record</span><span class="p">)</span>&#x000A;        <span class="p">{</span><span class="ss">:cemerick.friend/redirect-on-auth?</span> <span class="nv">false</span><span class="p">})</span>&#x000A;       <span class="p">(</span><span class="nf">invalid</span> <span class="nv">errors</span><span class="p">)))))</span>&#x000A;&#x000A;&#x000A;<span class="c1">;; [7] The compojure route, https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/middleware/routes.clj#L67</span>&#x000A;<span class="p">(</span><span class="nf">authroute</span> <span class="nv">POST</span> <span class="s">"/users"</span> <span class="nv">users/registration-success-response</span><span class="p">)</span>&#x000A;&#x000A;<span class="c1">;; [8] the final step in our journey</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">registration-success-response</span>&#x000A;  <span class="p">[</span><span class="nv">params</span> <span class="nv">auth</span><span class="p">]</span>&#x000A;  <span class="s">"If the request gets this far, it means that user registration was successful."</span>&#x000A;  <span class="p">(</span><span class="k">if </span><span class="nv">auth</span> <span class="p">{</span><span class="ss">:body</span> <span class="nv">auth</span><span class="p">}))</span></pre></div>
          <p>I'm both proud and appalled that I wrote all that code.</p>
          
          <h3>Testing a Clojure Web App is More Fun than Testing Rails</h3>
          
          <p>For testing I decided to try out
          <a href="https://github.com/marick/Midje">Midje</a>. Midje is easy to get used
          to, and @marick has articulated a clear and compelling philosophy for
          it.</p>
          
          <p>But before we get into some code let me explain the heading, "testing
          a Clojure web app is more fun than testing Rails." This has to do with
          Clojure itself and not with any testing library.</p>
          
          <p>There's no real magic in any of the code I wrote. Everything is just a
          function. You give it an input and it returns an output. You give your
          application a Ring request and it goes through all the layers and
          returns a Ring response. You don't have to do any crazy setup hijinks
          or create special environments like you do in Rails - especially like
          you have to do when testing controllers. This makes testing so much
          easier and more fun.</p>
          
          <p>So, that said, I feel like there's not much remarkable with my tests.
          There's a lot of room for improvement.</p>
          
          <p>I ended up creating a lot of
          <a href="https://github.com/flyingmachine/gratefulplace2/tree/v1.0.0/server/test/gratefulplace/controllers">helper functions</a>
          to DRY up my
          <a href="https://github.com/flyingmachine/gratefulplace2/tree/v1.0.0/server/test/gratefulplace/controllers">controller tests</a>,
          and those might prove helpful to someone else. I also ended up
          writing a crazy-ass macro for creating functions with default
          positional arguments:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">defmacro </span><span class="nv">defnpd</span>&#x000A;  <span class="c1">;; defn with default positional arguments</span>&#x000A;  <span class="p">[</span><span class="nb">name </span><span class="nv">args</span> <span class="o">&amp;</span> <span class="nv">body</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">unpack-defaults</span>&#x000A;        <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">args</span><span class="p">]</span>&#x000A;          <span class="p">(</span><span class="k">let </span><span class="p">[[</span><span class="nv">undefaulted</span> <span class="nv">defaulted</span><span class="p">]</span> <span class="p">(</span><span class="nb">split-with </span><span class="p">(</span><span class="nb">comp not </span><span class="nv">vector?</span><span class="p">)</span> <span class="nv">args</span><span class="p">)</span>&#x000A;                <span class="nv">argcount</span> <span class="p">(</span><span class="nb">count </span><span class="nv">args</span><span class="p">)]</span>&#x000A;            <span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">defaulted</span> <span class="nv">defaulted</span>&#x000A;                   <span class="nv">argset</span> <span class="p">{</span><span class="ss">:argnames</span> <span class="p">(</span><span class="nb">into </span><span class="p">[]</span> <span class="nv">undefaulted</span><span class="p">)</span>&#x000A;                           <span class="ss">:application</span> <span class="p">(</span><span class="nb">into </span><span class="p">[]</span> <span class="p">(</span><span class="nb">concat </span><span class="nv">undefaulted</span> <span class="p">(</span><span class="nb">map second </span><span class="nv">defaulted</span><span class="p">)))}</span>&#x000A;                   <span class="nv">unpacked-args</span> <span class="p">[</span><span class="nv">argset</span><span class="p">]</span>&#x000A;                   <span class="nv">position</span> <span class="p">(</span><span class="nb">count </span><span class="nv">undefaulted</span><span class="p">)]</span>&#x000A;              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">empty?</span> <span class="nv">defaulted</span><span class="p">)</span>&#x000A;                <span class="nv">unpacked-args</span>&#x000A;                <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">argname</span> <span class="p">(</span><span class="nb">ffirst </span><span class="nv">defaulted</span><span class="p">)</span>&#x000A;                      <span class="nv">new-argset</span> <span class="p">{</span><span class="ss">:argnames</span> <span class="p">(</span><span class="nb">conj </span><span class="p">(</span><span class="ss">:argnames</span> <span class="nv">argset</span><span class="p">)</span> <span class="nv">argname</span><span class="p">)</span>&#x000A;                                  <span class="ss">:application</span> <span class="p">(</span><span class="nb">assoc </span><span class="p">(</span><span class="ss">:application</span> <span class="nv">argset</span><span class="p">)</span> <span class="nv">position</span> <span class="nv">argname</span><span class="p">)}]</span>&#x000A;                  <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">rest </span><span class="nv">defaulted</span><span class="p">)</span> <span class="nv">new-argset</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">unpacked-args</span> <span class="nv">new-argset</span><span class="p">)</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">position</span><span class="p">)))))))</span>&#x000A;        <span class="nv">unpacked-args</span> <span class="p">(</span><span class="nf">unpack-defaults</span> <span class="nv">args</span><span class="p">)]</span>&#x000A;&#x000A;    <span class="o">`</span><span class="p">(</span><span class="kd">defn </span><span class="o">~</span><span class="nv">name</span>&#x000A;       <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="ss">:argnames</span> <span class="p">(</span><span class="nb">last </span><span class="nv">unpacked-args</span><span class="p">))</span>&#x000A;        <span class="o">~@</span><span class="nv">body</span><span class="p">)</span>&#x000A;       <span class="o">~@</span><span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="ss">:argnames</span> <span class="nv">%</span><span class="p">)</span>&#x000A;                     <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="nb">name </span><span class="o">~@</span><span class="p">(</span><span class="ss">:application</span> <span class="nv">%</span><span class="p">)))</span>&#x000A;              <span class="p">(</span><span class="nf">drop-last</span> <span class="nv">unpacked-args</span><span class="p">)))))</span>&#x000A;&#x000A;<span class="c1">;; Examples</span>&#x000A;<span class="p">(</span><span class="nf">defnpd</span> <span class="nv">response-data</span>&#x000A;  <span class="p">[</span><span class="nv">method</span> <span class="nb">path </span><span class="p">[</span><span class="nv">params</span> <span class="nv">nil</span><span class="p">]</span> <span class="p">[</span><span class="nv">auth</span> <span class="nv">nil</span><span class="p">]]</span>&#x000A;  <span class="p">(</span><span class="nf">data</span> <span class="p">(</span><span class="nf">res</span> <span class="nv">method</span> <span class="nb">path </span><span class="nv">params</span> <span class="nv">auth</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defnpd</span> <span class="nv">res</span>&#x000A;  <span class="p">[</span><span class="nv">method</span> <span class="nb">path </span><span class="p">[</span><span class="nv">params</span> <span class="nv">nil</span><span class="p">]</span> <span class="p">[</span><span class="nv">auth</span> <span class="nv">nil</span><span class="p">]]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">params</span> <span class="p">(</span><span class="nf">json/write-str</span> <span class="nv">params</span><span class="p">)]</span>&#x000A;       <span class="p">(</span><span class="nf">server/app</span> <span class="p">(</span><span class="nf">req</span> <span class="nv">method</span> <span class="nb">path </span><span class="nv">params</span> <span class="nv">auth</span><span class="p">))))</span></pre></div>
          <p>The next big step for me with testing is to get off my butt and figure
          out how to run some kind of autotest process with Midje.</p>
          
          <p>If you're new to Clojure and are wondering what testing library, I
          think <code>clojure.test</code> works just fine. It's easier to understand than
          Midje, but Midje seems more powerful.</p>
          
          <h3>Serving files generated by Grunt/Angular</h3>
          
          <p>While developing, the frontend files are located completely outside of
          the Clojure application. The directory structure looks like:</p>
          <div class="highlight"><pre><span class="o">/</span><span class="vg">server</span>&#x000A;<span class="w">  </span><span class="o">/</span><span class="vg">src</span>&#x000A;<span class="w">    </span><span class="o">/</span><span class="vg">gratefulplace</span>&#x000A;<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="vg">server</span><span class="o">.</span><span class="vg">clj</span>&#x000A;<span class="w">    </span><span class="o">/</span><span class="vg">resources</span>&#x000A;<span class="w">    </span><span class="o">...</span>&#x000A;<span class="o">/</span><span class="vg">html</span><span class="o">-</span><span class="vg">app</span>&#x000A;<span class="w">  </span><span class="o">/</span><span class="vg">app</span>&#x000A;<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="vg">index</span><span class="o">.</span><span class="vg">html</span>&#x000A;<span class="w">  </span><span class="o">/.</span><span class="vg">tmp</span>&#x000A;<span class="w">    </span><span class="o">/</span><span class="vg">scripts</span>&#x000A;<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="vg">app</span><span class="o">.</span><span class="vg">js</span>&#x000A;<span class="w">      </span><span class="o">/</span><span class="vg">controllers</span>&#x000A;<span class="w">        </span><span class="o">-</span><span class="w"> </span><span class="vg">topics</span><span class="o">.</span><span class="vg">js</span>&#x000A;<span class="w">        </span><span class="o">...</span></pre></div>
          <p>So I needed some way to get the Clojure app to actually serve up these
          files. I also needed to be able to serve the files when they're
          packaged as resources in the final uberjar. This turned out to be
          really easy:</p>
          <div class="highlight"><pre><span class="c1">;; https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/config.clj</span>&#x000A;<span class="c1">;; Example config</span>&#x000A;<span class="p">(</span><span class="nf">def</span> <span class="nv">conf</span>&#x000A;  <span class="p">(</span><span class="nf">merge-with</span>&#x000A;   <span class="nv">merge</span>&#x000A;   <span class="p">{</span><span class="ss">:html-paths</span> <span class="p">[</span><span class="s">"html-app"</span>&#x000A;                 <span class="s">"../html-app/app"</span>&#x000A;                 <span class="s">"../html-app/.tmp"</span><span class="p">]}))</span>&#x000A;<span class="p">(</span><span class="nf">defn</span> <span class="nv">config</span>&#x000A;  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">keys</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">get-in</span> <span class="nv">conf</span> <span class="nv">keys</span><span class="p">))</span>               &#x000A;&#x000A;<span class="c1">;; https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/middleware/routes.clj#L33</span>&#x000A;<span class="c1">;; Serve up angular app</span>&#x000A;<span class="p">(</span><span class="nb">apply</span> <span class="nv">compojure.core/routes</span>&#x000A;         <span class="p">(</span><span class="nb">map</span> <span class="o">#</span><span class="p">(</span><span class="nf">compojure.core/routes</span>&#x000A;                <span class="p">(</span><span class="nf">compojure.route/files</span> <span class="s">"/"</span> <span class="p">{</span><span class="ss">:root</span> <span class="nv">%</span><span class="p">})</span>&#x000A;                <span class="p">(</span><span class="nf">compojure.route/resources</span> <span class="s">"/"</span> <span class="p">{</span><span class="ss">:root</span> <span class="nv">%</span><span class="p">}))</span>&#x000A;              <span class="p">(</span><span class="nf">reverse</span> <span class="p">(</span><span class="nf">config</span> <span class="ss">:html-paths</span><span class="p">))))</span>&#x000A;<span class="c1">;; Route "/" to "/index.html"</span>&#x000A;<span class="p">(</span><span class="nb">apply</span> <span class="nv">compojure.core/routes</span>&#x000A;       <span class="p">(</span><span class="nb">map</span> <span class="p">(</span><span class="kd">fn </span><span class="p">[</span><span class="nv">response-fn</span><span class="p">]</span>&#x000A;              <span class="p">(</span><span class="nf">GET</span> <span class="s">"/"</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">response-fn</span> <span class="s">"index.html"</span> <span class="p">{</span><span class="ss">:root</span> <span class="s">"html-app"</span><span class="p">})))</span>&#x000A;            <span class="p">[</span><span class="nv">resp/file-response</span> <span class="nv">resp/resource-response</span><span class="p">]))</span></pre></div>
          <p>We're just iterating over each possible path for the front end files
          and creating both a file route and a resource route for them. This is
          a lazy way to do things, resulting in a few unnecessary routes. In the
          future, it would be nice to make the app "know" whether to use the
          single resource route, <code>html-app</code>, or whether it needs to use the file
          routes, <code>../html-app/app</code> and <code>../html-app/.tmp</code>.</p>
          
          <h3>The Uberjar</h3>
          
          <p>As I started to deploy the forum I found that I needed and easy way to
          run database-related tasks. Here's what I came up with:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">gratefulplace.app</span>&#x000A;  <span class="p">(</span><span class="ss">:gen-class</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">gratefulplace.server</span> <span class="ss">:as</span> <span class="nv">server</span><span class="p">]</span>&#x000A;            <span class="p">[</span><span class="nv">gratefulplace.db.manage</span> <span class="ss">:as</span> <span class="nv">db</span><span class="p">]))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span>&#x000A;  <span class="p">[</span><span class="nv">cmd</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">cond </span>&#x000A;   <span class="p">(</span><span class="nb">= </span><span class="nv">cmd</span> <span class="s">"server"</span><span class="p">)</span> <span class="p">(</span><span class="nf">server/-main</span><span class="p">)</span>&#x000A;   <span class="c1">;; I know there's repetition here please don't hate me :'(</span>&#x000A;   <span class="p">(</span><span class="nb">= </span><span class="nv">cmd</span> <span class="s">"db/reload"</span><span class="p">)</span> <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">db/reload</span><span class="p">))</span> <span class="p">(</span><span class="nf">System/exit</span> <span class="mi">0</span><span class="p">))</span>&#x000A;   <span class="p">(</span><span class="nb">= </span><span class="nv">cmd</span> <span class="s">"db/migrate"</span><span class="p">)</span> <span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nb">println </span><span class="p">(</span><span class="nf">db/migrate</span><span class="p">))</span> <span class="p">(</span><span class="nf">System/exit</span> <span class="mi">0</span><span class="p">))))</span></pre></div>
          <p>So you can run <code>java -jar gp2.jar server</code> and get a server running, or
          reload the database or run migrations. I could also have used <code>lein</code>
          on the server, and I'll probably do that eventually. For now I'm just
          creating uberjars and copying them over.</p>
          
          <p>Holy cow, the Clojure section is over! Let's talk about Datomic now!</p>
          
          <h2>Datomic</h2>
          
          <h3>Why Oh Why Did I Do This</h3>
          
          <p>When I set about re-writing the site it felt risky to use Datomic
          because a) I didn't know how to use it and b) it didn't seem like it
          would add much value over postgres or mysql for my tiny side project.</p>
          
          <p>But those were also compelling reasons to go with it: a) it's exciting
          to learn a completely new way of working with databases, designed by
          some really freaking smart people who know which side of the bread is
          buttered and b) it's just a tiny side project and I can do whatever I
          want.</p>
          
          <p>Ultimately I'm happy with the decision. I've learned a lot by
          researching Datomic (see
          "<a href="http://www.flyingmachinestudios.com/programming/datomic-for-five-year-olds/">Datomic for Five-Year-Olds</a>")
          and using it has afforded the same simple, lightweight experience as
          using Clojure.</p>
          
          <p>You won't find any mind-blowing code here – I'm still trying to
          learn how to use Datomic well – but hopefully you'll find it
          useful or interesting.</p>
          
          <h3>The Poopy Code I Wrote to Make Things "Easier"</h3>
          
          <p>I wrote a number of wrapper functions in the misleadingly-name
          <code>gratefulplace.db.query</code> namespace:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="kd">ns </span><span class="nv">gratefulplace.db.query</span>&#x000A;  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">datomic.api</span> <span class="ss">:as</span> <span class="nv">d</span><span class="p">])</span>&#x000A;  <span class="p">(</span><span class="ss">:use</span> <span class="nv">gratefulplace.config</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; This is dynamic so I can re-bind it for tests</span>&#x000A;<span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">*db-uri*</span> <span class="p">(</span><span class="nf">config</span> <span class="ss">:datomic</span> <span class="ss">:db-uri</span><span class="p">))</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">conn</span>&#x000A;  <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">d/connect</span> <span class="nv">*db-uri*</span><span class="p">))</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">db</span>&#x000A;  <span class="p">[]</span>&#x000A;  <span class="p">(</span><span class="nf">d/db</span> <span class="p">(</span><span class="nf">conn</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; Don't make me pass in the value of the database that gets boring</span>&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">q</span>&#x000A;  <span class="o">#</span><span class="p">(</span><span class="nf">d/q</span> <span class="nv">%</span> <span class="p">(</span><span class="nf">db</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; I'll give you an id, you give me a datomic entity or nil</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">ent</span>&#x000A;  <span class="p">[</span><span class="nv">id</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">exists</span> <span class="p">(</span><span class="nb">ffirst </span><span class="p">(</span><span class="nf">d/q</span> <span class="o">'</span><span class="p">[</span><span class="ss">:find</span> <span class="nv">?eid</span> <span class="ss">:in</span> <span class="nv">$</span> <span class="nv">?eid</span> <span class="ss">:where</span> <span class="p">[</span><span class="nv">?eid</span><span class="p">]]</span> <span class="p">(</span><span class="nf">db</span><span class="p">)</span> <span class="nv">id</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nf">d/entity</span> <span class="p">(</span><span class="nf">db</span><span class="p">)</span> <span class="nv">exists</span><span class="p">)</span>&#x000A;    <span class="nv">nil</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; Is this an entity?! Tell me!</span>&#x000A;<span class="p">(</span><span class="kd">defmulti </span><span class="nv">ent?</span> <span class="nv">class</span><span class="p">)</span>&#x000A;<span class="p">(</span><span class="kd">defmethod </span><span class="nv">ent?</span> <span class="nv">datomic.query.EntityMap</span> <span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="nv">x</span><span class="p">)</span>&#x000A;<span class="p">(</span><span class="kd">defmethod </span><span class="nv">ent?</span> <span class="ss">:default</span> <span class="p">[</span><span class="nv">x</span><span class="p">]</span> <span class="nv">false</span><span class="p">)</span>&#x000A;&#x000A;<span class="c1">;; I'll give you some conditions, you'll give me an entity id</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">eid</span>&#x000A;  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">conditions</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">conditions</span> <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">concat </span><span class="p">[</span><span class="ss">'?c</span><span class="p">]</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">conditions</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">{</span><span class="ss">:find</span> <span class="p">[</span><span class="ss">'?c</span><span class="p">]</span>&#x000A;         <span class="ss">:where</span> <span class="nv">conditions</span><span class="p">}</span>&#x000A;        <span class="nv">q</span>&#x000A;        <span class="nv">ffirst</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; I want one thing please</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">one</span>&#x000A;  <span class="p">[</span><span class="o">&amp;</span> <span class="nv">conditions</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">eid</span> <span class="nv">conditions</span><span class="p">)]</span>&#x000A;    <span class="p">(</span><span class="nf">ent</span> <span class="nv">id</span><span class="p">)))</span>&#x000A;&#x000A;<span class="c1">;; I want all the things please</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">all</span>&#x000A;  <span class="p">[</span><span class="nv">common-attribute</span> <span class="o">&amp;</span> <span class="nv">conditions</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">conditions</span> <span class="p">(</span><span class="nb">concat </span><span class="p">[[</span><span class="ss">'?c</span> <span class="nv">common-attribute</span><span class="p">]]</span>&#x000A;                           <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nb">concat </span><span class="p">[</span><span class="ss">'?c</span><span class="p">]</span> <span class="nv">%</span><span class="p">)</span> <span class="nv">conditions</span><span class="p">))]</span>&#x000A;    <span class="p">(</span><span class="nb">map </span><span class="o">#</span><span class="p">(</span><span class="nf">ent</span> <span class="p">(</span><span class="nb">first </span><span class="nv">%</span><span class="p">))</span> <span class="p">(</span><span class="nf">q</span> <span class="p">{</span><span class="ss">:find</span> <span class="p">[</span><span class="ss">'?c</span><span class="p">]</span>&#x000A;                              <span class="ss">:where</span> <span class="nv">conditions</span><span class="p">}))))</span>&#x000A;&#x000A;<span class="c1">;; Passing the connection all the time is boring</span>&#x000A;<span class="p">(</span><span class="k">def </span><span class="nv">t</span>&#x000A;  <span class="o">#</span><span class="p">(</span><span class="nf">d/transact</span> <span class="p">(</span><span class="nf">conn</span><span class="p">)</span> <span class="nv">%</span><span class="p">))</span>&#x000A;&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">resolve-tempid</span>&#x000A;  <span class="p">[</span><span class="nv">tempids</span> <span class="nv">tempid</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">d/resolve-tempid</span> <span class="p">(</span><span class="nf">db</span><span class="p">)</span> <span class="nv">tempids</span> <span class="nv">tempid</span><span class="p">))</span>&#x000A;&#x000A;<span class="c1">;; I make a lot of mistakes so please make it easy for me to retract them</span>&#x000A;<span class="p">(</span><span class="kd">defn </span><span class="nv">retract-entity</span>&#x000A;  <span class="p">[</span><span class="nv">eid</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="nf">t</span> <span class="p">[[</span><span class="ss">:db.fn/retractEntity</span> <span class="nv">eid</span><span class="p">]]))</span></pre></div>
          <p>Some of these functions simply reduce the code I write by a tiny bit,
          for example by allowing me to not pass a connection or database value
          into every single database-related function, which would make no sense
          for me as I only have one database.</p>
          
          <p>Others, like <code>one</code> and <code>all</code> provide me with an "easier" way of
          performing common queries but at the expense of sometimes writing
          queries in roundabout ways or taking away some of my flexibility.</p>
          
          <p>For example, in the <code>all</code> function I'm limited to only one data
          source. The result is that I sometimes have to use the <code>datomic.api</code>
          functions in places where I'd prefer not to, and the codebase doesn't
          quite feel cohesive. One example of this is the <code>query</code> function in
          the <code>watches</code> controller:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nf">defresource</span> <span class="nv">query</span> <span class="p">[</span><span class="nv">params</span> <span class="nv">auth</span><span class="p">]</span>&#x000A;  <span class="ss">:available-media-types</span> <span class="p">[</span><span class="s">"application/json"</span><span class="p">]</span>&#x000A;  <span class="ss">:handle-ok</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">ctx</span><span class="p">]</span>&#x000A;               <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">comp </span><span class="nv">record</span> <span class="nv">first</span><span class="p">)</span>&#x000A;                    <span class="p">(</span><span class="nf">d/q</span> <span class="o">'</span><span class="p">[</span><span class="ss">:find</span> <span class="nv">?watch</span>&#x000A;                           <span class="ss">:in</span> <span class="nv">$</span> <span class="nv">?userid</span>&#x000A;                           <span class="ss">:where</span> <span class="p">[</span><span class="nv">?watch</span> <span class="ss">:watch/user</span> <span class="nv">?userid</span><span class="p">]</span>&#x000A;                           <span class="p">[</span><span class="nv">?watch</span> <span class="ss">:watch/topic</span> <span class="nv">?topic</span><span class="p">]</span>&#x000A;                           <span class="p">[</span><span class="nv">?topic</span> <span class="ss">:content/deleted</span> <span class="nv">false</span><span class="p">]]</span>&#x000A;                         <span class="p">(</span><span class="nf">db/db</span><span class="p">)</span>&#x000A;                         <span class="p">(</span><span class="ss">:id</span> <span class="nv">auth</span><span class="p">)))))</span></pre></div>
          <p>I have to call <code>datomic.api/q</code> directly because I want to pass in
          <code>?userid</code>.</p>
          
          <p>I'm not sure whether I should drop these functions entirely and just
          use the datomic api or whether I should continue tweaking them to meet
          my needs.</p>
          
          <h3>The Good Code I Ripped Off to do Migrations</h3>
          
          <p>The
          <a href="https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/db/manage.clj"><code>gratefulplace.db.manage</code> namespace</a>
          has some code I stole and modified from Day of Datomic. It's a really
          cool, simple way of ensuring that migrations get run. The basic idea
          is that you keep track of schema names which have been installed, then
          install any schemas that haven't been installed. It's a simple,
          logical approach and the code that implements it is pretty neat, as
          you would expect from Stu Halloway.</p>
          
          <h3>Mapification with Cartographer, My Very Own Clojure Library!!!</h3>
          
          <p><a href="https://github.com/flyingmachine/cartographer">Cartographer</a> is the
          result of my attempt to easily do some processing and pull in
          relationships when converting a Datomic entity to a map. I think the
          README explains it all so you can learn more about it there. Here are
          some of the <code>maprules</code> used in GP2:</p>
          <div class="highlight"><pre><span class="c1">;; https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/db/maprules.clj</span>&#x000A;<span class="p">(</span><span class="nf">defmaprules</span> <span class="nv">ent-&gt;topic</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:id</span> <span class="ss">:db/id</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:title</span> <span class="ss">:topic/title</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:post-count</span> <span class="p">(</span><span class="nf">ref-count</span> <span class="ss">:post/topic</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:author-id</span> <span class="p">(</span><span class="nb">comp </span><span class="ss">:db/id</span> <span class="ss">:content/author</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:last-posted-to-at</span> <span class="p">(</span><span class="nb">comp </span><span class="nv">format-date</span> <span class="ss">:topic/last-posted-to-at</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">has-one</span> <span class="ss">:first-post</span>&#x000A;           <span class="ss">:rules</span> <span class="nv">gratefulplace.db.maprules/ent-&gt;post</span>&#x000A;           <span class="ss">:retriever</span> <span class="ss">:topic/first-post</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">has-one</span> <span class="ss">:author</span>&#x000A;           <span class="ss">:rules</span> <span class="nv">gratefulplace.db.maprules/ent-&gt;user</span>&#x000A;           <span class="ss">:retriever</span> <span class="ss">:content/author</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">has-many</span> <span class="ss">:posts</span>&#x000A;            <span class="ss">:rules</span> <span class="nv">gratefulplace.db.maprules/ent-&gt;post</span>&#x000A;            <span class="ss">:retriever</span> <span class="o">#</span><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:post/created-at</span>&#x000A;                                 <span class="p">(</span><span class="ss">:post/_topic</span> <span class="nv">%</span><span class="p">)))</span>&#x000A;  <span class="p">(</span><span class="nf">has-many</span> <span class="ss">:watches</span>&#x000A;            <span class="ss">:rules</span> <span class="nv">gratefulplace.db.maprules/ent-&gt;watch</span>&#x000A;            <span class="ss">:retriever</span> <span class="o">#</span><span class="p">(</span><span class="ss">:watch/_topic</span> <span class="nv">%</span><span class="p">)))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nf">defmaprules</span> <span class="nv">ent-&gt;post</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:id</span> <span class="ss">:db/id</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:content</span> <span class="p">(</span><span class="nf">mask-deleted</span> <span class="ss">:post/content</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:formatted-content</span> <span class="p">(</span><span class="nf">mask-deleted</span> <span class="o">#</span><span class="p">(</span><span class="nf">md-content</span> <span class="p">(</span><span class="ss">:post/content</span> <span class="nv">%</span><span class="p">))))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:deleted</span> <span class="ss">:content/deleted</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:created-at</span> <span class="p">(</span><span class="nb">comp </span><span class="nv">format-date</span> <span class="ss">:post/created-at</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:topic-id</span> <span class="p">(</span><span class="nb">comp </span><span class="ss">:db/id</span> <span class="ss">:post/topic</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:author-id</span> <span class="p">(</span><span class="nb">comp </span><span class="ss">:db/id</span> <span class="ss">:content/author</span><span class="p">))</span>&#x000A;  <span class="p">(</span><span class="nf">attr</span> <span class="ss">:likers</span> <span class="o">#</span><span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="nb">comp </span><span class="ss">:db/id</span> <span class="ss">:like/user</span><span class="p">)</span> <span class="p">(</span><span class="ss">:like/_post</span> <span class="nv">%</span><span class="p">)))</span>&#x000A;  <span class="p">(</span><span class="nf">has-one</span> <span class="ss">:author</span>&#x000A;           <span class="ss">:rules</span> <span class="nv">gratefulplace.db.maprules/ent-&gt;user</span>&#x000A;           <span class="ss">:retriever</span> <span class="ss">:content/author</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nf">has-one</span> <span class="ss">:topic</span>&#x000A;           <span class="ss">:rules</span> <span class="nv">gratefulplace.db.maprules/ent-&gt;topic</span>&#x000A;           <span class="ss">:retriever</span> <span class="ss">:post/topic</span><span class="p">))</span></pre></div>
          <p>There are definitely some edge cases where this approach gets strained
          but overall it's served me well.</p>
          
          <p>I ended up creating a macro which allows you to easily create a
          function that, when applied to a datomic entity, returns a map using
          <code>maprules</code> created with Cartographer:</p>
          <div class="highlight"><pre><span class="c1">;; https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/server/src/gratefulplace/db/mapification.clj</span>&#x000A;<span class="p">(</span><span class="kd">defmacro </span><span class="nv">defmapifier</span>&#x000A;  <span class="p">[</span><span class="nv">fn-name</span> <span class="nv">rules</span> <span class="o">&amp;</span> <span class="nv">mapify-opts</span><span class="p">]</span>&#x000A;  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">fn-name</span> <span class="nv">fn-name</span><span class="p">]</span>&#x000A;    <span class="o">`</span><span class="p">(</span><span class="kd">defn- </span><span class="o">~</span><span class="nv">fn-name</span>&#x000A;       <span class="p">([</span><span class="nv">id#</span><span class="p">]</span>&#x000A;          <span class="p">(</span><span class="o">~</span><span class="nv">fn-name</span> <span class="nv">id#</span> <span class="p">{}))</span>&#x000A;       <span class="p">([</span><span class="nv">id#</span> <span class="nv">addtl-mapify-args#</span><span class="p">]</span>&#x000A;          <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">ent#</span> <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">db/ent?</span> <span class="nv">id#</span><span class="p">)</span> <span class="p">(</span><span class="nf">db/ent</span> <span class="nv">id#</span><span class="p">))]</span>&#x000A;            <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">mapify-opts#</span> <span class="p">(</span><span class="nb">merge-with </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_#</span> <span class="nv">x#</span><span class="p">]</span> <span class="nv">x#</span><span class="p">)</span> <span class="o">~@</span><span class="nv">mapify-opts</span> <span class="nv">addtl-mapify-args#</span><span class="p">)]</span>&#x000A;              <span class="p">(</span><span class="nf">fyingmachine.cartographer/mapify</span>&#x000A;               <span class="nv">ent#</span>&#x000A;               <span class="o">~</span><span class="nv">rules</span>&#x000A;               <span class="nv">mapify-opts#</span><span class="p">))</span>&#x000A;            <span class="nv">nil</span><span class="p">)))))</span></pre></div>
          <h2>Angular</h2>
          
          <p>I've been learning Angular since last November and I love it. Using
          it, I feel like I finally have the right tools for creating web apps.</p>
          
          <h3>Peeking and Secondary Controllers</h3>
          
          <p>I wanted to implement the idea of "peeking" at things on the forum.
          For example, if you click on a user link you'll just view a summary of
          his info in the right column instead of completely leaving the page
          you're on.</p>
          
          <p>The idea is that, while reading a thread, you might find a response
          interesting. You want to know a little more about the author but don't
          want to lose your place. So you "peek" at him, which shows you some
          info and preserves your place in the thread. It was just something fun
          I wanted to try.</p>
          
          <p>However, as far as I know Angular doesn't make this very easy for you.
          The approach I took was to have a
          <a href="https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/html-app/app/scripts/controllers/foundation.coffee">Foundation controller</a>
          which places the
          <a href="https://github.com/flyingmachine/gratefulplace2/blob/v1.0.0/html-app/app/scripts/services/support.coffee">Support</a>
          service on the scope. Since all other controllers are nested under
          <code>Foundation</code>, they'll have access to <code>$scope.support</code>.</p>
          
          <p>The purpose of <code>Support</code> is define a way to show views in the right
          column and make data accessible to the view. For example, the author
          directive has the following:</p>
          <div class="highlight"><pre><span class="nx">https</span><span class="o">://</span><span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">flyingmachine</span><span class="o">/</span><span class="nx">gratefulplace2</span><span class="o">/</span><span class="nx">blob</span><span class="o">/</span><span class="nx">v1</span><span class="p">.</span><span class="mf">0.0</span><span class="o">/</span><span class="nx">html</span><span class="o">-</span><span class="nx">app</span><span class="o">/</span><span class="nx">app</span><span class="o">/</span><span class="nx">scripts</span><span class="o">/</span><span class="nx">directives</span><span class="o">/</span><span class="nx">author</span><span class="p">.</span><span class="nx">coffee</span><span class="c1">#L8</span>&#x000A;<span class="nv">$scope.peekAtAuthor = </span><span class="nf">(author)-&gt;</span>&#x000A;  <span class="nx">User</span><span class="p">.</span><span class="nx">get</span> <span class="nv">id: </span><span class="nx">author</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nf">(data)-&gt;</span>&#x000A;    <span class="nx">_</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">posts</span><span class="p">).</span><span class="nx">reverse</span><span class="p">()</span>&#x000A;    <span class="nv">data.posts = </span><span class="nx">_</span><span class="p">.</span><span class="nx">take</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">posts</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>&#x000A;    <span class="nx">Support</span><span class="p">.</span><span class="nx">peek</span><span class="p">.</span><span class="nx">show</span><span class="p">(</span><span class="s">"user"</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span></pre></div>
          <p>The base view has the following:</p>
          <div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"more"</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"secondary"</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;ng-include</span> <span class="na">src=</span><span class="s">"support.secondaryNav.include()"</span><span class="nt">&gt;&lt;/ng-include&gt;</span>&#x000A;  <span class="nt">&lt;/nav&gt;</span>&#x000A;  <span class="nt">&lt;ng-include</span> <span class="na">src=</span><span class="s">"support.peek.include()"</span><span class="nt">&gt;&lt;/ng-include&gt;</span>&#x000A;<span class="nt">&lt;/div&gt;</span></pre></div>
          <p>And the user peek looks like this:</p>
          <div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"peek"</span><span class="nt">&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"username"</span><span class="nt">&gt;</span>{{support.peek.data.username}}<span class="nt">&lt;/h3&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"about"</span> <span class="na">ng-bind-html-unsafe=</span><span class="s">"support.peek.data['formatted-about']"</span><span class="nt">&gt;&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"recent-posts"</span><span class="nt">&gt;</span>&#x000A;    <span class="nt">&lt;h4&gt;</span>Recent Posts<span class="nt">&lt;/h4&gt;</span>&#x000A;    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"post"</span> <span class="na">ng-repeat=</span><span class="s">"post in support.peek.data.posts"</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;date</span> <span class="na">data=</span><span class="s">"post['created-at']"</span><span class="nt">&gt;&lt;/date&gt;</span>&#x000A;      <span class="nt">&lt;div&gt;</span>&#x000A;        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#/topics/{{post.topic.id}}"</span><span class="nt">&gt;</span>{{post.topic.title || 'view topic'}}<span class="nt">&lt;/a&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span> <span class="na">ng-bind-html-unsafe=</span><span class="s">"post.content"</span><span class="nt">&gt;</span>&#x000A;      <span class="nt">&lt;/div&gt;</span>&#x000A;    <span class="nt">&lt;/div&gt;</span>&#x000A;  <span class="nt">&lt;/div&gt;</span>&#x000A;<span class="nt">&lt;/div&gt;</span></pre></div>
          <p>So, ultimately, what's happenins is that when you call
          <code>Support.peek.show("user", data)</code>, it sets some variables so that the
          view associated with the "user" peek is shown. That view then accesses
          the data you passed to <code>Support.peek.show</code> with, e.g.,
          <code>support.peek.data.username</code>.</p>
          
          <p>I know this isn't a super-detailed explanation of what's going on, but
          I hope some investigation of the code will answer any questions you
          might have.</p>
          
          <h3>Directives to the Rescue</h3>
          
          <p>Angular directives are as powerful as everyone says they are, and I
          think I'm finally utilizing them well. You can see all my
          <a href="https://github.com/flyingmachine/gratefulplace2/tree/v1.0.0/html-app/app/scripts/directives">directives on github</a>.</p>
          
          <p>This article is already 500 times to long so I won't go into any
          details, but if you're looking to understand Angular better, read this
          excellent
          <a href="http://stackoverflow.com/questions/14994391/how-do-i-think-in-angularjs-emberjsor-other-client-mvc-framework-if-i-have-a">SO response to How do I “think in AngularJS/EmberJS(or other client MVC framework)” if I have a jQuery background?</a>.</p>
          
          <h2>Infrastructure</h2>
          
          <p>Because GP2 uses Datomic Free, I couldn't deploy to Heroku. This meant
          having to actually handle provisioning a server myself and deploying
          without following a tutorial. In the end things are working well. The
          site's residing on a [Digital Ocean][https://www.digitalocean.com/]
          server, which has been very easy to work with.</p>
          
          <h3>Creating a Local Sandbox with Vagrant</h3>
          
          <p>Creating a local sandbox lets you make all your provisioning mistakes
          more quickly. If you're creating a new provisioning script of tweaking
          your existing one, you should do it in a virtual machine.</p>
          
          <p><a href="http://www.vagrantup.com">Vagrant</a> makes this process as easy as an
          old shoe. Once you've installed virtualbox and vagrant all you have to
          do is run <code>vagrant up</code> from the <code>infrastructure</code> directory and you'll
          have a virtual machine ready to go. The Vagrant web site has excellent
          tutorials so check it out if you want to learn more.</p>
          
          <h3>Provisioning with Ansible</h3>
          
          <p><a href="http://www.ansibleworks.com/docs/gettingstarted.html/">Ansible's</a>
          supposed to be super simple compared to Puppet and Chef. I found it
          easy to learn. It's also simple enough to easily modify scripts and
          powerful enough to do exactly what I want it to, which is provision a
          server with Java and Datomic and deploy my app to it. You can check
          out my setup in <code>infrastructure/ansible</code>. If you're using Datomic free
          please do use it as a starting point.</p>
          
          <p><code>provision.yml</code> has just about everything you need to get a server up
          and running, with the exception of uploading SSH keys. <code>deploy.yml</code> is
          used by the janky bash script below to upload an uberjar, run
          migrations, and restart the server.</p>
          
          <h3>Building and Deploying with a Janky Bash Script and Ansible</h3>
          
          <p>Here's my janky Bash scripts which first build the app and then
          deploys it with Ansible:</p>
          <div class="highlight"><pre><span class="c"># build.sh</span>&#x000A;<span class="c">#!/bin/bash</span>&#x000A;<span class="nb">cd </span>html-app&#x000A;grunt build&#x000A;rm -Rf ../server/resources/html-app&#x000A;cp -R targets/public ../server/resources/html-app&#x000A;<span class="nb">cd</span> ../server&#x000A;lein uberjar&#x000A;<span class="nb">cd</span> ..&#x000A;cp  server/target/gratefulplace-0.1.0-SNAPSHOT-standalone.jar infrastructure/ansible/files/gp2.jar&#x000A;&#x000A;<span class="c"># deploy.sh</span>&#x000A;<span class="c">#!/bin/bash</span>&#x000A;die <span class="o">()</span> <span class="o">{</span>&#x000A;  <span class="nb">echo</span> &gt;<span class="p">&amp;</span><span class="m">2</span> <span class="s2">"$@"</span>&#x000A;  <span class="nb">exit </span>1&#x000A;<span class="o">}</span>&#x000A;&#x000A;<span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> -eq <span class="m">0</span> <span class="o">]</span>&#x000A;<span class="k">then</span> <span class="nv">INVENTORY</span><span class="o">=</span><span class="s2">"dev"</span>&#x000A;<span class="k">else</span> <span class="nv">INVENTORY</span><span class="o">=</span><span class="nv">$1</span>&#x000A;<span class="k">fi</span>&#x000A;&#x000A;<span class="o">[</span> -e infrastructure/ansible/<span class="nv">$INVENTORY</span> <span class="o">]</span> <span class="o">||</span> die <span class="s2">"Inventory file $INVENTORY not found"</span>&#x000A;&#x000A;./build.sh&#x000A;<span class="nb">cd </span>infrastructure/ansible/&#x000A;ansible-playbook -i <span class="nv">$INVENTORY</span> deploy.yml</pre></div>
          <h2>Workflow</h2>
          
          <p>OMG this article is almost over! Listen, I know you don't need to know
          this and it makes no difference to you but I am out here in the North
          Carolina heat sweating my ass off trying to finish this article so I
          can get on with my day. So it's pretty exciting that we're almost
          done.</p>
          
          <p>Anyway - here are workflow improvements I developed over the course of
          this project. You might also want to check out this
          <a href="http://thinkrelevance.com/blog/2013/06/04/clojure-workflow-reloaded">My Clojure Workflow, Reloaded</a>.</p>
          
          <h3>Emacs Bookmarks, Snippets, and Keybindings</h3>
          
          <p>I created a
          <a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Bookmarks.html">bookmark</a>
          to open my <code>server/src/gratefulplace/server.clj</code> file with just a few
          keystrokes instead of having to navigate to it. I recommend doing this
          for any project which you'll be toiling over for months on end!</p>
          
          <h3>Keybindings</h3>
          
          <p>Behold, my very first keybinding! This starts the Jetty server:</p>
          <div class="highlight"><pre><span class="p">(</span><span class="nb">defun</span> <span class="nv">nrepl-start-http-server</span> <span class="p">()</span>&#x000A;  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nv">nrepl-load-current-buffer</span><span class="p">)</span>&#x000A;  <span class="p">(</span><span class="nv">nrepl-set-ns</span> <span class="p">(</span><span class="nv">nrepl-current-ns</span><span class="p">))</span>&#x000A;  <span class="c1">;; (with-current-buffer (nrepl-current-repl-buffer)</span>&#x000A;  <span class="c1">;;   (nrepl-send-string "(def server (-main)) (println server)"))</span>&#x000A;  <span class="p">(</span><span class="nv">nrepl-interactive-eval</span> <span class="p">(</span><span class="nb">format</span> <span class="s">"(println '(def server (%s/-main))) (println 'server)"</span> <span class="p">(</span><span class="nv">nrepl-current-ns</span><span class="p">)))</span>&#x000A;  <span class="p">(</span><span class="nv">nrepl-interactive-eval</span> <span class="p">(</span><span class="nb">format</span> <span class="s">"(def server (%s/-main)) (println server)"</span> <span class="p">(</span><span class="nv">nrepl-current-ns</span><span class="p">))))</span>&#x000A;&#x000A;<span class="p">(</span><span class="nv">eval-after-load</span> <span class="ss">'nrepl</span>&#x000A;  <span class="o">'</span><span class="p">(</span><span class="nv">define-key</span> <span class="nv">clojure-mode-map</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">"C-c C-v"</span><span class="p">)</span> <span class="ss">'nrepl-start-http-server</span><span class="p">))</span></pre></div>
          <p>So, once you have <code>server.clj</code> open and you've run <code>nrepl-jack-in</code> you
          can hit <code>C-c C-v</code> to start the server. Also check out the
          <a href="https://github.com/clojure-emacs/nrepl.el#keyboard-shortcuts">nrepl keybindings</a>
          for some great workflow helpers.</p>
          
          <h3>tmuxinator config</h3>
          
          <p>In order to do development you need to have Datomic and Grunt running.
          Instead of having to open up a bunch of terminal tabs and handle all
          that manually every time I want to start working, I use tmuxinator so
          that I can get my environment set up in one comand. Here's my config:</p>
          <div class="highlight"><pre><span class="c1"># ~/.tmuxinator/nicu.yml</span>&#x000A;<span class="c1"># you can make as many tabs as you wish...</span>&#x000A;&#x000A;<span class="l-Scalar-Plain">project_name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gp2</span>&#x000A;<span class="l-Scalar-Plain">project_root</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~/projects/web_sites/gp2</span>&#x000A;<span class="l-Scalar-Plain">rvm</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1.9.3</span>&#x000A;<span class="l-Scalar-Plain">tabs</span><span class="p-Indicator">:</span>&#x000A;  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">angular_server</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">git pull &amp;&amp; cd html-app &amp;&amp; grunt server</span>&#x000A;  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">datomic</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">datomic</span>&#x000A;  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> </pre></div>
          <p>I also have these nice little bash aliases:</p>
          <div class="highlight"><pre><span class="nb">alias</span> <span class="s2">"tmk"</span><span class="o">=</span><span class="s2">"tmux kill-session -t"</span>&#x000A;<span class="nb">alias</span> <span class="s2">"datomic"</span><span class="o">=</span><span class="s2">"~/src/datomic/bin/transactor ~/src/datomic/config/samples/free-transactor-template.properties"</span></pre></div>
          <h3>Actually Doing Development</h3>
          
          <p>So, in order to get to the point where you can actually start writing
          code and seeing the results, do the following:</p>
          
          <ol>
          <li>Install datomic and set up your own datomic alias</li>
          <li>Run <code>mux gp2</code> to start tmux with your tmuxinator conf</li>
          <li>Open emacs</li>
          <li>Hit <code>C-x r l</code> to open your list of bookmarks and choose the
          bookmark for <code>server.clj</code>
          </li>
          <li>Run <code>M-x nrepl-jack-in</code> in emacs</li>
          <li>Hit <code>C-c C-v</code> to start the jetty server</li>
          </ol>
          
          <h2>The End</h2>
          
          <p>That's it! I hope you've found this article useful. I'm going to go
          have a life for a little while now. Haha, just kidding! I'm going to
          spend the next two hours hitting refresh on my reddit submission!</p>
          <p>
            <a class='twitter-share-button' data-via='nonrecursive' href='https://twitter.com/share'>Tweet</a>
          </p>
          <script>
            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs')
          </script>
          <h2>Comments</h2>
          <div id='disqus_thread'></div>
          <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'flyingmachinestudios'; // required: replace example with your forum shortname
            
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>
        </div>
      </div>
      <div id='nav'>
        <div class='articles'>
          <h2>Popular Blog Posts</h2>
          <ol>
            <li>
              <a class='title' href='/programming/the-unofficial-guide-to-rich-hickeys-brain/'>The Unofficial Guide to Rich Hickey's Brain</a>
            </li>
            <li>
              <a class='title' href='/programming/datomic-for-five-year-olds/'>Datomic for Five-Year-Olds</a>
            </li>
            <li>
              <a class='title' href='/programming/how-clojure-babies-are-made-lein-run/'>How Clojure Babies Are Made: Understanding lein run</a>
            </li>
          </ol>
          <h2>Recent Blog Posts</h2>
          <ol>
            <li>
              <a class='title' href='/programming/why-programmers-need-frameworks/'>Frameworks and Why (Clojure) Programmers Need Them</a>
            </li>
            <li>
              <a class='title' href='/people/buddy-system/'>Buddy Systems at Work: a Framework for Rewarding Relationships on Remote Teams</a>
            </li>
            <li>
              <a class='title' href='/programming/learn-programming-languages-efficiently/'>Techniques for Efficiently Learning Programming Languages</a>
            </li>
            <li>
              <a class='title' href='/essays/zen-joker/'>Zen and the Art of Blowing Things Up</a>
            </li>
            <li>
              <a class='title' href='/essays/process/'>My Writing Process</a>
            </li>
            <li>
              <a class='title' href='/programming/recursion/'>Understanding Recursion</a>
            </li>
            <li>
              <a class='title' href='/programming/timeless-tools/'>Timeless Programming Tools</a>
            </li>
          </ol>
        </div>
        <div class='projects'>
          <h2>Projects</h2>
          <ol>
            <li id='cftbat'>
              <header>
                <a href='http://braveclojure.com'>
                  Clojure for the Brave and True
                </a>
                <p>A goofy book for learning Clojure. No functional programming or Java experience required!</p>
              </header>
            </li>
            <li id='cuym'>
              <header>
                <a href='http://www.visualmess.com'>
                  Clean Up Your Mess: a Guide to Visual Design for Everyone
                </a>
              </header>
              <p>
                This popular guide will help you
                communicate with conscious skill. It will show you
                how to create designs that are easy to understand
                and attractive.
              </p>
            </li>
            <li id='gratefulplace'>
              <header>
                <a href='http://gratefulplace.com'>
                  Grateful Place
                </a>
              </header>
              <p>When we appreciate the good in our lives, the good grows and we have more of it.</p>
            </li>
          </ol>
        </div>
      </div>
    </div>
    <script>
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-666015-1']);
      _gaq.push(['_trackPageview']);
      
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
